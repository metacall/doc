"use strict";(globalThis.webpackChunkmetacall_doc=globalThis.webpackChunkmetacall_doc||[]).push([[5153],{3484:(e,l,r)=>{r.r(l),r.d(l,{assets:()=>t,contentTitle:()=>c,default:()=>h,frontMatter:()=>n,metadata:()=>o,toc:()=>d});const o=JSON.parse('{"id":"metacall-core/creating-custom-loaders","title":"Creating Custom Loaders","description":"Relevant source files","source":"@site/docs/metacall-core/creating-custom-loaders.md","sourceDirName":"metacall-core","slug":"/metacall-core/creating-custom-loaders","permalink":"/doc/docs/metacall-core/creating-custom-loaders","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"title":"Creating Custom Loaders"},"sidebar":"tutorialSidebar","previous":{"title":"Core Components","permalink":"/doc/docs/metacall-core/core-components"},"next":{"title":"Detours System","permalink":"/doc/docs/metacall-core/detours-system"}}');var a=r(4848),s=r(8453);const n={title:"Creating Custom Loaders"},c="Creating Custom Loaders",t={},d=[{value:"Relevant source files",id:"relevant-source-files",level:2},{value:"Overview of the Loader System",id:"overview-of-the-loader-system",level:2},{value:"Loader Architecture in MetaCall",id:"loader-architecture-in-metacall",level:3},{value:"Loader Interface",id:"loader-interface",level:2},{value:"Step-by-Step Guide to Creating a Custom Loader",id:"step-by-step-guide-to-creating-a-custom-loader",level:2},{value:"1. Project Structure",id:"1-project-structure",level:3},{value:"2. Implementing the Loader Interface",id:"2-implementing-the-loader-interface",level:3},{value:"2.1 Initialize",id:"21-initialize",level:4},{value:"2.2 Load From File",id:"22-load-from-file",level:4},{value:"2.3 Load From Memory",id:"23-load-from-memory",level:4},{value:"2.4 Load From Package",id:"24-load-from-package",level:4},{value:"2.5 Clear",id:"25-clear",level:4},{value:"2.6 Discover",id:"26-discover",level:4},{value:"2.7 Destroy",id:"27-destroy",level:4},{value:"3. Value Conversion System",id:"3-value-conversion-system",level:3},{value:"4. Function Call Interface",id:"4-function-call-interface",level:3},{value:"5. Handling Asynchronous Code",id:"5-handling-asynchronous-code",level:3},{value:"6. CMake Configuration",id:"6-cmake-configuration",level:3},{value:"Type System Integration",id:"type-system-integration",level:2},{value:"Required Types to Support",id:"required-types-to-support",level:3},{value:"Best Practices",id:"best-practices",level:2},{value:"Memory Management",id:"memory-management",level:3},{value:"Thread Safety",id:"thread-safety",level:3},{value:"Error Handling",id:"error-handling",level:3},{value:"Testing Your Loader",id:"testing-your-loader",level:2},{value:"Bootstrap and Initialization",id:"bootstrap-and-initialization",level:2},{value:"Conclusion",id:"conclusion",level:2}];function i(e){const l={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(l.header,{children:(0,a.jsx)(l.h1,{id:"creating-custom-loaders",children:"Creating Custom Loaders"})}),"\n",(0,a.jsx)(l.h2,{id:"relevant-source-files",children:"Relevant source files"}),"\n",(0,a.jsxs)(l.ul,{children:["\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/cmake/CompileOptions.cmake",children:"cmake/CompileOptions.cmake"})}),"\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/cmake/FindNodeJS.cmake",children:"cmake/FindNodeJS.cmake"})}),"\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/cli/metacallcli/test/cli-test-rb.py.in",children:"source/cli/metacallcli/test/cli-test-rb.py.in"})}),"\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/cli/metacallcli/test/cli-test.py.in",children:"source/cli/metacallcli/test/cli-test.py.in"})}),"\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/CMakeLists.txt",children:"source/loaders/node_loader/CMakeLists.txt"})}),"\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/bootstrap/lib/bootstrap.js",children:"source/loaders/node_loader/bootstrap/lib/bootstrap.js"})}),"\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/include/node_loader/node_loader_impl.h",children:"source/loaders/node_loader/include/node_loader/node_loader_impl.h"})}),"\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/include/node_loader/node_loader_trampoline.h",children:"source/loaders/node_loader/include/node_loader/node_loader_trampoline.h"})}),"\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/source/node_loader_impl.cpp",children:"source/loaders/node_loader/source/node_loader_impl.cpp"})}),"\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/source/node_loader_port.cpp",children:"source/loaders/node_loader/source/node_loader_port.cpp"})}),"\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/source/node_loader_trampoline.cpp",children:"source/loaders/node_loader/source/node_loader_trampoline.cpp"})}),"\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/py_loader/include/py_loader/py_loader_dict.h",children:"source/loaders/py_loader/include/py_loader/py_loader_dict.h"})}),"\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/py_loader/include/py_loader/py_loader_impl.h",children:"source/loaders/py_loader/include/py_loader/py_loader_impl.h"})}),"\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/py_loader/source/py_loader_dict.c",children:"source/loaders/py_loader/source/py_loader_dict.c"})}),"\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/py_loader/source/py_loader_impl.c",children:"source/loaders/py_loader/source/py_loader_impl.c"})}),"\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/py_loader/source/py_loader_port.c",children:"source/loaders/py_loader/source/py_loader_port.c"})}),"\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/ts_loader/CMakeLists.txt",children:"source/loaders/ts_loader/CMakeLists.txt"})}),"\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/ts_loader/bootstrap/lib/bootstrap.ts",children:"source/loaders/ts_loader/bootstrap/lib/bootstrap.ts"})}),"\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/ports/py_port/metacall/__init__.py",children:"source/ports/py_port/metacall/__init__.py"})}),"\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/ports/py_port/metacall/api.py",children:"source/ports/py_port/metacall/api.py"})}),"\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/scripts/python/pointer/source/pointer.py.in",children:"source/scripts/python/pointer/source/pointer.py.in"})}),"\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/tests/metacall_node_async_test/source/metacall_node_async_test.cpp",children:"source/tests/metacall_node_async_test/source/metacall_node_async_test.cpp"})}),"\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/tests/metacall_node_test/source/main.cpp",children:"source/tests/metacall_node_test/source/main.cpp"})}),"\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/tests/metacall_node_test/source/metacall_node_test.cpp",children:"source/tests/metacall_node_test/source/metacall_node_test.cpp"})}),"\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/tests/metacall_python_async_test/CMakeLists.txt",children:"source/tests/metacall_python_async_test/CMakeLists.txt"})}),"\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/tests/metacall_python_async_test/source/main.cpp",children:"source/tests/metacall_python_async_test/source/main.cpp"})}),"\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/tests/metacall_python_async_test/source/metacall_python_async_test.cpp",children:"source/tests/metacall_python_async_test/source/metacall_python_async_test.cpp"})}),"\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/tests/metacall_python_pointer_test/source/metacall_python_pointer_test.cpp",children:"source/tests/metacall_python_pointer_test/source/metacall_python_pointer_test.cpp"})}),"\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/tests/metacall_python_port_import_test/source/metacall_python_port_import_test.cpp",children:"source/tests/metacall_python_port_import_test/source/metacall_python_port_import_test.cpp"})}),"\n"]}),"\n",(0,a.jsx)(l.p,{children:"This guide explains how to create custom language loaders for MetaCall. Loaders are plugins that enable MetaCall to execute code written in specific programming languages. By creating a custom loader, you can add support for languages not currently integrated into MetaCall or implement specialized versions of existing language runtimes."}),"\n",(0,a.jsxs)(l.p,{children:["For information about using existing loaders, please refer to their respective documentation pages (see ",(0,a.jsx)(l.a,{href:"/doc/docs/metacall-core/python-loader",children:"Python Loader"}),", ",(0,a.jsx)(l.a,{href:"/doc/docs/metacall-core/node-js-loader",children:"Node.js Loader"}),", etc.)."]}),"\n",(0,a.jsx)(l.h2,{id:"overview-of-the-loader-system",children:"Overview of the Loader System"}),"\n",(0,a.jsx)(l.p,{children:"The MetaCall Loader System serves as a bridge between the MetaCall Core and various language runtimes. Each loader is responsible for loading code from a specific language, executing it within its native runtime, and facilitating cross-language function calls through the MetaCall reflection system."}),"\n",(0,a.jsx)(l.h3,{id:"loader-architecture-in-metacall",children:"Loader Architecture in MetaCall"}),"\n",(0,a.jsxs)(l.ul,{children:["\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/source/node_loader_impl.cpp",children:"source/loaders/node_loader/source/node_loader_impl.cpp"})}),"\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/py_loader/source/py_loader_impl.c",children:"source/loaders/py_loader/source/py_loader_impl.c"})}),"\n"]}),"\n",(0,a.jsx)(l.h2,{id:"loader-interface",children:"Loader Interface"}),"\n",(0,a.jsx)(l.p,{children:"Every loader must implement the loader interface defined in the MetaCall Core. This interface consists of several key functions that handle initialization, code loading, function discovery, and cleanup."}),"\n",(0,a.jsxs)(l.ul,{children:["\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/include/node_loader/node_loader_impl.h#L38-L52",children:"source/loaders/node_loader/include/node_loader/node_loader_impl.h38-52"})}),"\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/py_loader/include/py_loader/py_loader_impl.h#L39-L53",children:"source/loaders/py_loader/include/py_loader/py_loader_impl.h39-53"})}),"\n"]}),"\n",(0,a.jsx)(l.h2,{id:"step-by-step-guide-to-creating-a-custom-loader",children:"Step-by-Step Guide to Creating a Custom Loader"}),"\n",(0,a.jsx)(l.h3,{id:"1-project-structure",children:"1. Project Structure"}),"\n",(0,a.jsx)(l.p,{children:"Start by creating the directory structure for your loader plugin:"}),"\n",(0,a.jsx)(l.pre,{children:(0,a.jsx)(l.code,{children:"source/loaders/my_loader/\n\u251c\u2500\u2500 CMakeLists.txt                        # Build configuration\n\u251c\u2500\u2500 include/\n\u2502   \u2514\u2500\u2500 my_loader/\n\u2502       \u251c\u2500\u2500 my_loader.h                   # Public API\n\u2502       \u251c\u2500\u2500 my_loader_impl.h              # Implementation interface\n\u2502       \u2514\u2500\u2500 my_loader_api.h               # Export macros\n\u2514\u2500\u2500 source/\n    \u251c\u2500\u2500 my_loader.c                       # Entry point\n    \u2514\u2500\u2500 my_loader_impl.c/cpp              # Implementation\n"})}),"\n",(0,a.jsxs)(l.ul,{children:["\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/CMakeLists.txt",children:"source/loaders/node_loader/CMakeLists.txt"})}),"\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/py_loader/source/py_loader_impl.c",children:"source/loaders/py_loader/source/py_loader_impl.c"})}),"\n"]}),"\n",(0,a.jsx)(l.h3,{id:"2-implementing-the-loader-interface",children:"2. Implementing the Loader Interface"}),"\n",(0,a.jsx)(l.p,{children:"Your loader implementation must provide functions for each of the methods defined in the loader interface. Here's an overview of what each function should do:"}),"\n",(0,a.jsx)(l.h4,{id:"21-initialize",children:"2.1 Initialize"}),"\n",(0,a.jsx)(l.p,{children:"This function initializes your language runtime and sets up any necessary state for the loader. It should:"}),"\n",(0,a.jsxs)(l.ol,{children:["\n",(0,a.jsx)(l.li,{children:"Initialize the language runtime"}),"\n",(0,a.jsx)(l.li,{children:"Create data structures to track loaded modules"}),"\n",(0,a.jsx)(l.li,{children:"Register the loader with the MetaCall reflection system"}),"\n",(0,a.jsx)(l.li,{children:"Return a pointer to the loader's implementation data"}),"\n"]}),"\n",(0,a.jsx)(l.p,{children:"Example implementation patterns:"}),"\n",(0,a.jsxs)(l.ul,{children:["\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/py_loader/source/py_loader_impl.c",children:"source/loaders/py_loader/source/py_loader_impl.c"})}),"\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/source/node_loader_impl.cpp#L917-L1109",children:"source/loaders/node_loader/source/node_loader_impl.cpp917-1109"})}),"\n"]}),"\n",(0,a.jsx)(l.h4,{id:"22-load-from-file",children:"2.2 Load From File"}),"\n",(0,a.jsx)(l.p,{children:"This function loads code from one or more files. It should:"}),"\n",(0,a.jsxs)(l.ol,{children:["\n",(0,a.jsx)(l.li,{children:"Process each file path"}),"\n",(0,a.jsx)(l.li,{children:"Load and execute the code using the language runtime"}),"\n",(0,a.jsx)(l.li,{children:"Create a handle to represent the loaded module(s)"}),"\n",(0,a.jsx)(l.li,{children:"Return the handle for further operations"}),"\n"]}),"\n",(0,a.jsxs)(l.ul,{children:["\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/py_loader/source/py_loader_impl.c",children:"source/loaders/py_loader/source/py_loader_impl.c"})}),"\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/source/node_loader_impl.cpp#L1419-L1484",children:"source/loaders/node_loader/source/node_loader_impl.cpp1419-1484"})}),"\n"]}),"\n",(0,a.jsx)(l.h4,{id:"23-load-from-memory",children:"2.3 Load From Memory"}),"\n",(0,a.jsx)(l.p,{children:"This function loads code from a memory buffer. It should:"}),"\n",(0,a.jsxs)(l.ol,{children:["\n",(0,a.jsx)(l.li,{children:"Compile/interpret the provided code buffer"}),"\n",(0,a.jsx)(l.li,{children:"Execute it in the language runtime"}),"\n",(0,a.jsx)(l.li,{children:"Create a handle to represent the loaded module"}),"\n",(0,a.jsx)(l.li,{children:"Return the handle"}),"\n"]}),"\n",(0,a.jsxs)(l.ul,{children:["\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/py_loader/source/py_loader_impl.c",children:"source/loaders/py_loader/source/py_loader_impl.c"})}),"\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/source/node_loader_impl.cpp#L1486-L1528",children:"source/loaders/node_loader/source/node_loader_impl.cpp1486-1528"})}),"\n"]}),"\n",(0,a.jsx)(l.h4,{id:"24-load-from-package",children:"2.4 Load From Package"}),"\n",(0,a.jsx)(l.p,{children:"This function loads code from a package (e.g., compiled libraries, archives). It should:"}),"\n",(0,a.jsxs)(l.ol,{children:["\n",(0,a.jsx)(l.li,{children:"Load the specified package using the language's package system"}),"\n",(0,a.jsx)(l.li,{children:"Initialize the package in the runtime"}),"\n",(0,a.jsx)(l.li,{children:"Create a handle to represent the loaded package"}),"\n",(0,a.jsx)(l.li,{children:"Return the handle"}),"\n"]}),"\n",(0,a.jsxs)(l.ul,{children:["\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/py_loader/source/py_loader_impl.c",children:"source/loaders/py_loader/source/py_loader_impl.c"})}),"\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/source/node_loader_impl.cpp#L1530-L1553",children:"source/loaders/node_loader/source/node_loader_impl.cpp1530-1553"})}),"\n"]}),"\n",(0,a.jsx)(l.h4,{id:"25-clear",children:"2.5 Clear"}),"\n",(0,a.jsx)(l.p,{children:"This function clears a previously loaded module/package. It should:"}),"\n",(0,a.jsxs)(l.ol,{children:["\n",(0,a.jsx)(l.li,{children:"Free resources associated with the handle"}),"\n",(0,a.jsx)(l.li,{children:"Remove the module from the language runtime if applicable"}),"\n",(0,a.jsx)(l.li,{children:"Return 0 on success, non-zero on failure"}),"\n"]}),"\n",(0,a.jsxs)(l.ul,{children:["\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/py_loader/source/py_loader_impl.c",children:"source/loaders/py_loader/source/py_loader_impl.c"})}),"\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/source/node_loader_impl.cpp#L1555-L1588",children:"source/loaders/node_loader/source/node_loader_impl.cpp1555-1588"})}),"\n"]}),"\n",(0,a.jsx)(l.h4,{id:"26-discover",children:"2.6 Discover"}),"\n",(0,a.jsx)(l.p,{children:"This function discovers functions and other symbols in a loaded module. It should:"}),"\n",(0,a.jsxs)(l.ol,{children:["\n",(0,a.jsx)(l.li,{children:"Traverse the module to find exported functions/objects"}),"\n",(0,a.jsx)(l.li,{children:"For each found function, register it with the reflection system"}),"\n",(0,a.jsx)(l.li,{children:"Handle type information for parameters and return values"}),"\n",(0,a.jsx)(l.li,{children:"Return 0 on success, non-zero on failure"}),"\n"]}),"\n",(0,a.jsxs)(l.ul,{children:["\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/py_loader/source/py_loader_impl.c#L181-L196",children:"source/loaders/py_loader/source/py_loader_impl.c181-196"})}),"\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/source/node_loader_impl.cpp#L1590-L1642",children:"source/loaders/node_loader/source/node_loader_impl.cpp1590-1642"})}),"\n"]}),"\n",(0,a.jsx)(l.h4,{id:"27-destroy",children:"2.7 Destroy"}),"\n",(0,a.jsx)(l.p,{children:"This function cleans up and shuts down the loader. It should:"}),"\n",(0,a.jsxs)(l.ol,{children:["\n",(0,a.jsx)(l.li,{children:"Free all resources associated with the loader"}),"\n",(0,a.jsx)(l.li,{children:"Shutdown the language runtime properly"}),"\n",(0,a.jsx)(l.li,{children:"Return 0 on success, non-zero on failure"}),"\n"]}),"\n",(0,a.jsxs)(l.ul,{children:["\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/py_loader/source/py_loader_impl.c",children:"source/loaders/py_loader/source/py_loader_impl.c"})}),"\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/source/node_loader_impl.cpp#L1644-L1671",children:"source/loaders/node_loader/source/node_loader_impl.cpp1644-1671"})}),"\n"]}),"\n",(0,a.jsx)(l.h3,{id:"3-value-conversion-system",children:"3. Value Conversion System"}),"\n",(0,a.jsx)(l.p,{children:"One of the most critical aspects of implementing a loader is handling value conversion between MetaCall's type system and your language's native types."}),"\n",(0,a.jsx)(l.p,{children:"For each direction of conversion, you need to implement handler functions:"}),"\n",(0,a.jsxs)(l.ol,{children:["\n",(0,a.jsxs)(l.li,{children:[(0,a.jsx)(l.strong,{children:"Language to MetaCall"}),": Convert your language's native types to MetaCall value types"]}),"\n",(0,a.jsxs)(l.li,{children:[(0,a.jsx)(l.strong,{children:"MetaCall to Language"}),": Convert MetaCall value types back to your language's native types"]}),"\n"]}),"\n",(0,a.jsx)(l.p,{children:"These conversions need to handle all of MetaCall's supported value types, including complex types like arrays, maps, and function references."}),"\n",(0,a.jsxs)(l.ul,{children:["\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/py_loader/source/py_loader_impl.c#L875-L1267",children:"source/loaders/py_loader/source/py_loader_impl.c875-1267"})}),"\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/source/node_loader_impl.cpp#L1210-L1451",children:"source/loaders/node_loader/source/node_loader_impl.cpp1210-1451"})}),"\n"]}),"\n",(0,a.jsx)(l.h3,{id:"4-function-call-interface",children:"4. Function Call Interface"}),"\n",(0,a.jsx)(l.p,{children:"Your loader must also implement a way to call functions defined in your language from MetaCall. This typically involves:"}),"\n",(0,a.jsxs)(l.ol,{children:["\n",(0,a.jsx)(l.li,{children:"Creating a function interface that bridges between MetaCall and your language"}),"\n",(0,a.jsx)(l.li,{children:"Handling parameter conversion"}),"\n",(0,a.jsx)(l.li,{children:"Managing return values"}),"\n",(0,a.jsx)(l.li,{children:"Proper error handling"}),"\n"]}),"\n",(0,a.jsx)(l.p,{children:"For asynchronous languages, you may also need to implement support for Promises/Futures."}),"\n",(0,a.jsxs)(l.ul,{children:["\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/py_loader/source/py_loader_impl.c#L357-L423",children:"source/loaders/py_loader/source/py_loader_impl.c357-423"})}),"\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/source/node_loader_impl.cpp#L3200-L3280",children:"source/loaders/node_loader/source/node_loader_impl.cpp3200-3280"})}),"\n"]}),"\n",(0,a.jsx)(l.h3,{id:"5-handling-asynchronous-code",children:"5. Handling Asynchronous Code"}),"\n",(0,a.jsx)(l.p,{children:"For languages with asynchronous capabilities (like JavaScript with Promises), you need to implement support for the MetaCall future API:"}),"\n",(0,a.jsxs)(l.ul,{children:["\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/source/node_loader_impl.cpp#L3283-L3367",children:"source/loaders/node_loader/source/node_loader_impl.cpp3283-3367"})}),"\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/py_loader/source/py_loader_impl.c#L835-L870",children:"source/loaders/py_loader/source/py_loader_impl.c835-870"})}),"\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/tests/metacall_node_async_test/source/metacall_node_async_test.cpp#L75-L210",children:"source/tests/metacall_node_async_test/source/metacall_node_async_test.cpp75-210"})}),"\n"]}),"\n",(0,a.jsx)(l.h3,{id:"6-cmake-configuration",children:"6. CMake Configuration"}),"\n",(0,a.jsx)(l.p,{children:"Your loader needs a proper CMakeLists.txt file to integrate with the MetaCall build system. Here's a template:"}),"\n",(0,a.jsxs)(l.ul,{children:["\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/CMakeLists.txt",children:"source/loaders/node_loader/CMakeLists.txt"})}),"\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/ts_loader/CMakeLists.txt",children:"source/loaders/ts_loader/CMakeLists.txt"})}),"\n"]}),"\n",(0,a.jsx)(l.h2,{id:"type-system-integration",children:"Type System Integration"}),"\n",(0,a.jsx)(l.p,{children:"A critical part of creating a custom loader is proper integration with MetaCall's type system. Your loader must map between native language types and MetaCall's type system."}),"\n",(0,a.jsx)(l.h3,{id:"required-types-to-support",children:"Required Types to Support"}),"\n",(0,a.jsxs)(l.table,{children:[(0,a.jsx)(l.thead,{children:(0,a.jsxs)(l.tr,{children:[(0,a.jsx)(l.th,{children:"MetaCall Type"}),(0,a.jsx)(l.th,{children:"Description"}),(0,a.jsx)(l.th,{children:"Example in Implementation"})]})}),(0,a.jsxs)(l.tbody,{children:[(0,a.jsxs)(l.tr,{children:[(0,a.jsx)(l.td,{children:(0,a.jsx)(l.code,{children:"NULL"})}),(0,a.jsx)(l.td,{children:"Null/None value"}),(0,a.jsx)(l.td,{children:"Map to language's null/nil/None"})]}),(0,a.jsxs)(l.tr,{children:[(0,a.jsx)(l.td,{children:(0,a.jsx)(l.code,{children:"BOOL"})}),(0,a.jsx)(l.td,{children:"Boolean value"}),(0,a.jsx)(l.td,{children:"Convert to/from language's boolean"})]}),(0,a.jsxs)(l.tr,{children:[(0,a.jsx)(l.td,{children:(0,a.jsx)(l.code,{children:"CHAR"})}),(0,a.jsx)(l.td,{children:"Single character"}),(0,a.jsx)(l.td,{children:"Map to char or single-character string"})]}),(0,a.jsxs)(l.tr,{children:[(0,a.jsxs)(l.td,{children:[(0,a.jsx)(l.code,{children:"INT"}),"/",(0,a.jsx)(l.code,{children:"LONG"})]}),(0,a.jsx)(l.td,{children:"Integer values"}),(0,a.jsx)(l.td,{children:"Map to language integers"})]}),(0,a.jsxs)(l.tr,{children:[(0,a.jsxs)(l.td,{children:[(0,a.jsx)(l.code,{children:"FLOAT"}),"/",(0,a.jsx)(l.code,{children:"DOUBLE"})]}),(0,a.jsx)(l.td,{children:"Floating point values"}),(0,a.jsx)(l.td,{children:"Map to language floats"})]}),(0,a.jsxs)(l.tr,{children:[(0,a.jsx)(l.td,{children:(0,a.jsx)(l.code,{children:"STRING"})}),(0,a.jsx)(l.td,{children:"Text string"}),(0,a.jsx)(l.td,{children:"Map to language string type"})]}),(0,a.jsxs)(l.tr,{children:[(0,a.jsx)(l.td,{children:(0,a.jsx)(l.code,{children:"ARRAY"})}),(0,a.jsx)(l.td,{children:"Sequence of values"}),(0,a.jsx)(l.td,{children:"Map to language arrays/lists"})]}),(0,a.jsxs)(l.tr,{children:[(0,a.jsx)(l.td,{children:(0,a.jsx)(l.code,{children:"MAP"})}),(0,a.jsx)(l.td,{children:"Key-value mapping"}),(0,a.jsx)(l.td,{children:"Map to language dictionaries/objects"})]}),(0,a.jsxs)(l.tr,{children:[(0,a.jsx)(l.td,{children:(0,a.jsx)(l.code,{children:"POINTER"})}),(0,a.jsx)(l.td,{children:"Raw pointer"}),(0,a.jsx)(l.td,{children:"Special handling for FFI"})]}),(0,a.jsxs)(l.tr,{children:[(0,a.jsx)(l.td,{children:(0,a.jsx)(l.code,{children:"FUNCTION"})}),(0,a.jsx)(l.td,{children:"Function reference"}),(0,a.jsx)(l.td,{children:"Wrap language functions"})]}),(0,a.jsxs)(l.tr,{children:[(0,a.jsx)(l.td,{children:(0,a.jsx)(l.code,{children:"FUTURE"})}),(0,a.jsx)(l.td,{children:"Async result"}),(0,a.jsx)(l.td,{children:"Map to language promises/futures"})]})]})]}),"\n",(0,a.jsxs)(l.ul,{children:["\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/py_loader/source/py_loader_impl.c#L875-L952",children:"source/loaders/py_loader/source/py_loader_impl.c875-952"})}),"\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/source/node_loader_impl.cpp#L1210-L1267",children:"source/loaders/node_loader/source/node_loader_impl.cpp1210-1267"})}),"\n"]}),"\n",(0,a.jsx)(l.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,a.jsx)(l.h3,{id:"memory-management",children:"Memory Management"}),"\n",(0,a.jsx)(l.p,{children:"Proper memory management is crucial for loaders:"}),"\n",(0,a.jsxs)(l.ol,{children:["\n",(0,a.jsxs)(l.li,{children:[(0,a.jsx)(l.strong,{children:"Ref counting"}),": Ensure proper reference counting for language objects"]}),"\n",(0,a.jsxs)(l.li,{children:[(0,a.jsx)(l.strong,{children:"Resource cleanup"}),": Free all resources in the destroy method"]}),"\n",(0,a.jsxs)(l.li,{children:[(0,a.jsx)(l.strong,{children:"Value ownership"}),": Be clear about who owns values during conversion"]}),"\n"]}),"\n",(0,a.jsxs)(l.ul,{children:["\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/py_loader/source/py_loader_impl.c#L193-L194",children:"source/loaders/py_loader/source/py_loader_impl.c193-194"})}),"\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/source/node_loader_impl.cpp#L1145-L1158",children:"source/loaders/node_loader/source/node_loader_impl.cpp1145-1158"})}),"\n"]}),"\n",(0,a.jsx)(l.h3,{id:"thread-safety",children:"Thread Safety"}),"\n",(0,a.jsx)(l.p,{children:"Many language runtimes have specific threading models:"}),"\n",(0,a.jsxs)(l.ol,{children:["\n",(0,a.jsxs)(l.li,{children:[(0,a.jsx)(l.strong,{children:"GIL"}),": Python's Global Interpreter Lock requires careful handling"]}),"\n",(0,a.jsxs)(l.li,{children:[(0,a.jsx)(l.strong,{children:"Event loops"}),": Node.js's event loop must be respected"]}),"\n",(0,a.jsxs)(l.li,{children:[(0,a.jsx)(l.strong,{children:"Thread access"}),": Some runtimes only allow API calls from specific threads"]}),"\n"]}),"\n",(0,a.jsx)(l.p,{children:"The MetaCall core may call your loader from different threads, so proper synchronization is necessary."}),"\n",(0,a.jsxs)(l.ul,{children:["\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/py_loader/source/py_loader_threading.h",children:"source/loaders/py_loader/source/py_loader_threading.h"})}),"\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/source/node_loader_impl.cpp#L202-L233",children:"source/loaders/node_loader/source/node_loader_impl.cpp202-233"})}),"\n"]}),"\n",(0,a.jsx)(l.h3,{id:"error-handling",children:"Error Handling"}),"\n",(0,a.jsx)(l.p,{children:"Proper error handling is essential for a stable loader:"}),"\n",(0,a.jsxs)(l.ol,{children:["\n",(0,a.jsxs)(l.li,{children:[(0,a.jsx)(l.strong,{children:"Language exceptions"}),": Catch and convert language exceptions to MetaCall errors"]}),"\n",(0,a.jsxs)(l.li,{children:[(0,a.jsx)(l.strong,{children:"Error propagation"}),": Ensure errors are properly propagated back to callers"]}),"\n",(0,a.jsxs)(l.li,{children:[(0,a.jsx)(l.strong,{children:"Cleanup on error"}),": Release resources even when errors occur"]}),"\n"]}),"\n",(0,a.jsxs)(l.ul,{children:["\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/py_loader/source/py_loader_impl.c#L157-L161",children:"source/loaders/py_loader/source/py_loader_impl.c157-161"})}),"\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/source/node_loader_impl.cpp#L945-L1033",children:"source/loaders/node_loader/source/node_loader_impl.cpp945-1033"})}),"\n"]}),"\n",(0,a.jsx)(l.h2,{id:"testing-your-loader",children:"Testing Your Loader"}),"\n",(0,a.jsx)(l.p,{children:"Testing is critical to ensure your loader correctly implements all required functionality:"}),"\n",(0,a.jsxs)(l.ol,{children:["\n",(0,a.jsxs)(l.li,{children:[(0,a.jsx)(l.strong,{children:"Basic loading"}),": Test loading scripts from file and memory"]}),"\n",(0,a.jsxs)(l.li,{children:[(0,a.jsx)(l.strong,{children:"Function calls"}),": Test calling functions with various parameter types"]}),"\n",(0,a.jsxs)(l.li,{children:[(0,a.jsx)(l.strong,{children:"Error cases"}),": Test error handling and edge cases"]}),"\n",(0,a.jsxs)(l.li,{children:[(0,a.jsx)(l.strong,{children:"Type conversions"}),": Test all type conversions in both directions"]}),"\n",(0,a.jsxs)(l.li,{children:[(0,a.jsx)(l.strong,{children:"Asynchronous operations"}),": Test async function calls if applicable"]}),"\n"]}),"\n",(0,a.jsx)(l.p,{children:"Look at existing tests for examples of how to test your loader:"}),"\n",(0,a.jsxs)(l.ul,{children:["\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/tests/metacall_node_test/source/metacall_node_test.cpp",children:"source/tests/metacall_node_test/source/metacall_node_test.cpp"})}),"\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/tests/metacall_python_async_test/source/metacall_python_async_test.cpp",children:"source/tests/metacall_python_async_test/source/metacall_python_async_test.cpp"})}),"\n"]}),"\n",(0,a.jsx)(l.h2,{id:"bootstrap-and-initialization",children:"Bootstrap and Initialization"}),"\n",(0,a.jsx)(l.p,{children:"Some loaders (like the Node.js loader) use a bootstrap process to initialize the language runtime and set up necessary callbacks. If your language runtime requires special initialization, you might need to implement a similar bootstrap mechanism."}),"\n",(0,a.jsxs)(l.ul,{children:["\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/bootstrap/lib/bootstrap.js",children:"source/loaders/node_loader/bootstrap/lib/bootstrap.js"})}),"\n",(0,a.jsx)(l.li,{children:(0,a.jsx)(l.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/ts_loader/bootstrap/lib/bootstrap.ts",children:"source/loaders/ts_loader/bootstrap/lib/bootstrap.ts"})}),"\n"]}),"\n",(0,a.jsx)(l.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,a.jsx)(l.p,{children:"Creating a custom loader for MetaCall involves implementing the loader interface, handling type conversions, managing function calls, and dealing with language-specific challenges. By following this guide and studying the existing loaders, you can integrate new languages into the MetaCall ecosystem."}),"\n",(0,a.jsx)(l.p,{children:"Remember to carefully handle:"}),"\n",(0,a.jsxs)(l.ul,{children:["\n",(0,a.jsx)(l.li,{children:"Memory management between MetaCall and your language runtime"}),"\n",(0,a.jsx)(l.li,{children:"Thread safety considerations for your language"}),"\n",(0,a.jsx)(l.li,{children:"Proper type conversions in both directions"}),"\n",(0,a.jsx)(l.li,{children:"Error handling and propagation"}),"\n"]}),"\n",(0,a.jsx)(l.p,{children:"With a well-implemented loader, you can seamlessly integrate your preferred programming language with all other languages supported by MetaCall, enabling true polyglot programming."})]})}function h(e={}){const{wrapper:l}={...(0,s.R)(),...e.components};return l?(0,a.jsx)(l,{...e,children:(0,a.jsx)(i,{...e})}):i(e)}},8453:(e,l,r)=>{r.d(l,{R:()=>n,x:()=>c});var o=r(6540);const a={},s=o.createContext(a);function n(e){const l=o.useContext(s);return o.useMemo(function(){return"function"==typeof e?e(l):{...l,...e}},[l,e])}function c(e){let l;return l=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:n(e.components),o.createElement(s.Provider,{value:l},e.children)}}}]);