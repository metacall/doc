"use strict";(globalThis.webpackChunkmetacall_doc=globalThis.webpackChunkmetacall_doc||[]).push([[141],{8356:(e,t,s)=>{s.r(t),s.d(t,{assets:()=>o,contentTitle:()=>n,default:()=>h,frontMatter:()=>a,metadata:()=>l,toc:()=>c});const l=JSON.parse('{"id":"metacall-core/rust-loader","title":"Rust Loader","description":"Relevant source files","source":"@site/docs/metacall-core/rust-loader.md","sourceDirName":"metacall-core","slug":"/metacall-core/rust-loader","permalink":"/doc/docs/metacall-core/rust-loader","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"title":"Rust Loader"},"sidebar":"tutorialSidebar","previous":{"title":"Running Tests","permalink":"/doc/docs/metacall-core/running-tests"},"next":{"title":"Rust Port","permalink":"/doc/docs/metacall-core/rust-port"}}');var r=s(4848),i=s(8453);const a={title:"Rust Loader"},n="Rust Loader",o={},c=[{value:"Relevant source files",id:"relevant-source-files",level:2},{value:"Overview",id:"overview",level:2},{value:"Current Status",id:"current-status",level:2},{value:"Architecture",id:"architecture",level:2},{value:"Component Structure",id:"component-structure",level:3},{value:"Loading and Execution Flow",id:"loading-and-execution-flow",level:3},{value:"Implementation Details",id:"implementation-details",level:2},{value:"Code Loading Methods",id:"code-loading-methods",level:3},{value:"Rust Function Exports",id:"rust-function-exports",level:3},{value:"Object-Oriented Programming Support",id:"object-oriented-programming-support",level:3},{value:"Build System",id:"build-system",level:2},{value:"Rust Toolchain Requirements",id:"rust-toolchain-requirements",level:3},{value:"Build Process",id:"build-process",level:3},{value:"Runtime Dependencies",id:"runtime-dependencies",level:3},{value:"Configuration and Debugging",id:"configuration-and-debugging",level:2},{value:"Environment Variables",id:"environment-variables",level:3},{value:"Build Options",id:"build-options",level:3},{value:"Limitations and Future Work",id:"limitations-and-future-work",level:2},{value:"Current Limitations",id:"current-limitations",level:3},{value:"Future Improvements",id:"future-improvements",level:3}];function d(e){const t={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.header,{children:(0,r.jsx)(t.h1,{id:"rust-loader",children:"Rust Loader"})}),"\n",(0,r.jsx)(t.h2,{id:"relevant-source-files",children:"Relevant source files"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://github.com/metacall/core/blob/af9cad19/cmake/FindPatchelf.cmake",children:"cmake/FindPatchelf.cmake"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://github.com/metacall/core/blob/af9cad19/cmake/FindRust.cmake",children:"cmake/FindRust.cmake"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://github.com/metacall/core/blob/af9cad19/cmake/InstallGBench.cmake",children:"cmake/InstallGBench.cmake"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://github.com/metacall/core/blob/af9cad19/cmake/InstallGTest.cmake",children:"cmake/InstallGTest.cmake"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://github.com/metacall/core/blob/af9cad19/cmake/InstallLibTCC.cmake",children:"cmake/InstallLibTCC.cmake"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://github.com/metacall/core/blob/af9cad19/cmake/InstallPatchelf.cmake",children:"cmake/InstallPatchelf.cmake"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://github.com/metacall/core/blob/af9cad19/deploy/CMakeLists.txt",children:"deploy/CMakeLists.txt"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/c_loader/CMakeLists.txt",children:"source/loaders/c_loader/CMakeLists.txt"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/cs_loader/CMakeLists.txt",children:"source/loaders/cs_loader/CMakeLists.txt"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/file_loader/CMakeLists.txt",children:"source/loaders/file_loader/CMakeLists.txt"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/js_loader/CMakeLists.txt",children:"source/loaders/js_loader/CMakeLists.txt"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/jsm_loader/CMakeLists.txt",children:"source/loaders/jsm_loader/CMakeLists.txt"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/mock_loader/CMakeLists.txt",children:"source/loaders/mock_loader/CMakeLists.txt"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/py_loader/CMakeLists.txt",children:"source/loaders/py_loader/CMakeLists.txt"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/rb_loader/CMakeLists.txt",children:"source/loaders/rb_loader/CMakeLists.txt"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/rs_loader/CMakeLists.txt",children:"source/loaders/rs_loader/CMakeLists.txt"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/rs_loader/rust/.cargo/config",children:"source/loaders/rs_loader/rust/.cargo/config"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/rs_loader/rust/.vscode/launch.json.in",children:"source/loaders/rs_loader/rust/.vscode/launch.json.in"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/rs_loader/rust/CMakeLists.txt",children:"source/loaders/rs_loader/rust/CMakeLists.txt"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/rs_loader/rust/rust-toolchain",children:"source/loaders/rs_loader/rust/rust-toolchain"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/rs_loader/rust/test/file.rs",children:"source/loaders/rs_loader/rust/test/file.rs"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/serials/metacall_serial/CMakeLists.txt",children:"source/serials/metacall_serial/CMakeLists.txt"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/serials/rapid_json_serial/CMakeLists.txt",children:"source/serials/rapid_json_serial/CMakeLists.txt"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/tests/metacall_rust_class_test/CMakeLists.txt",children:"source/tests/metacall_rust_class_test/CMakeLists.txt"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/tests/metacall_rust_load_from_mem_test/CMakeLists.txt",children:"source/tests/metacall_rust_load_from_mem_test/CMakeLists.txt"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/tests/metacall_rust_load_from_package_class_test/CMakeLists.txt",children:"source/tests/metacall_rust_load_from_package_class_test/CMakeLists.txt"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/tests/metacall_rust_load_from_package_test/CMakeLists.txt",children:"source/tests/metacall_rust_load_from_package_test/CMakeLists.txt"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/tests/metacall_rust_test/CMakeLists.txt",children:"source/tests/metacall_rust_test/CMakeLists.txt"})}),"\n"]}),"\n",(0,r.jsx)(t.h2,{id:"overview",children:"Overview"}),"\n",(0,r.jsx)(t.p,{children:"The Rust Loader is a component of the MetaCall Core framework that enables loading and executing Rust code from other programming languages. It integrates Rust's performance, safety features, and ecosystem into MetaCall's polyglot environment, allowing cross-language function calls to and from Rust."}),"\n",(0,r.jsxs)(t.p,{children:["For information about the overall MetaCall loader architecture, see ",(0,r.jsx)(t.a,{href:"/doc/docs/metacall-core/loader-system",children:"Loader System"}),". This document focuses specifically on the Rust Loader's implementation, capabilities, and configuration."]}),"\n",(0,r.jsx)(t.h2,{id:"current-status",children:"Current Status"}),"\n",(0,r.jsx)(t.p,{children:"As of the current version, the Rust Loader is marked as out of date and disabled by default. It was originally developed for Rust nightly-2021-12-04 toolchain and requires updating to work with newer Rust compiler versions. It also lacks support for the MUSL toolchain used for static linking."}),"\n",(0,r.jsx)(t.h2,{id:"architecture",children:"Architecture"}),"\n",(0,r.jsx)(t.p,{children:"The Rust Loader implements a split architecture pattern where the interface with MetaCall is written in C, while the actual implementation is written in Rust for better integration with the Rust ecosystem."}),"\n",(0,r.jsx)(t.h3,{id:"component-structure",children:"Component Structure"}),"\n",(0,r.jsx)(t.p,{children:"The Rust Loader consists of two primary components:"}),"\n",(0,r.jsxs)(t.ol,{children:["\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"rs_loader"}),": A C library that implements the loader interface required by MetaCall's Loader Manager. It handles the communication between MetaCall and the Rust implementation."]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"rs_loader_impl"}),": A Rust library that contains the actual loader implementation. This component handles compiling, loading, and executing Rust code by interfacing with the Rust toolchain."]}),"\n"]}),"\n",(0,r.jsx)(t.h3,{id:"loading-and-execution-flow",children:"Loading and Execution Flow"}),"\n",(0,r.jsx)(t.p,{children:"The sequence diagram above illustrates how the Rust Loader handles loading and executing Rust code through MetaCall."}),"\n",(0,r.jsx)(t.h2,{id:"implementation-details",children:"Implementation Details"}),"\n",(0,r.jsx)(t.h3,{id:"code-loading-methods",children:"Code Loading Methods"}),"\n",(0,r.jsx)(t.p,{children:"The Rust Loader supports three primary methods for loading Rust code:"}),"\n",(0,r.jsxs)(t.table,{children:[(0,r.jsx)(t.thead,{children:(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.th,{children:"Method"}),(0,r.jsx)(t.th,{children:"Function"}),(0,r.jsx)(t.th,{children:"Description"})]})}),(0,r.jsxs)(t.tbody,{children:[(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"File"}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"metacall_load_from_file"})}),(0,r.jsx)(t.td,{children:"Loads Rust code from .rs source files"})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"Memory"}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"metacall_load_from_memory"})}),(0,r.jsx)(t.td,{children:"Loads Rust code provided as a string in memory"})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"Package"}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"metacall_load_from_package"})}),(0,r.jsx)(t.td,{children:"Loads a Rust package (Cargo project structure)"})]})]})]}),"\n",(0,r.jsx)(t.h3,{id:"rust-function-exports",children:"Rust Function Exports"}),"\n",(0,r.jsx)(t.p,{children:"For Rust functions to be accessible from MetaCall, they must be:"}),"\n",(0,r.jsxs)(t.ol,{children:["\n",(0,r.jsxs)(t.li,{children:["Marked with the ",(0,r.jsx)(t.code,{children:"#[no_mangle]"})," attribute to prevent name mangling during compilation"]}),"\n",(0,r.jsxs)(t.li,{children:["Declared as ",(0,r.jsx)(t.code,{children:'pub extern "C"'})," to use the C calling convention"]}),"\n",(0,r.jsx)(t.li,{children:"Use types that can be represented in the C type system or have proper conversions"}),"\n"]}),"\n",(0,r.jsx)(t.p,{children:"Example of a properly exported Rust function:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:'#[no_mangle]\npub extern "C" fn multiply(a: i32, b: i32) -> i32 {\n    a * b\n}\n'})}),"\n",(0,r.jsx)(t.h3,{id:"object-oriented-programming-support",children:"Object-Oriented Programming Support"}),"\n",(0,r.jsx)(t.p,{children:"The Rust Loader supports object-oriented programming patterns by mapping Rust structs and their implementations to classes in other languages. This enables:"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:"Creating instances of Rust structs from other languages"}),"\n",(0,r.jsx)(t.li,{children:"Calling methods on these instances"}),"\n",(0,r.jsx)(t.li,{children:"Managing memory and lifetimes appropriately"}),"\n"]}),"\n",(0,r.jsx)(t.h2,{id:"build-system",children:"Build System"}),"\n",(0,r.jsx)(t.h3,{id:"rust-toolchain-requirements",children:"Rust Toolchain Requirements"}),"\n",(0,r.jsx)(t.p,{children:"The Rust Loader has specific toolchain requirements:"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:"Uses Rust nightly-2021-12-04 toolchain"}),"\n",(0,r.jsxs)(t.li,{children:["Requires several Rust components:","\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:"cargo"}),"\n",(0,r.jsx)(t.li,{children:"clippy"}),"\n",(0,r.jsx)(t.li,{children:"llvm-tools-preview"}),"\n",(0,r.jsx)(t.li,{children:"rls"}),"\n",(0,r.jsx)(t.li,{children:"rust-analysis"}),"\n",(0,r.jsx)(t.li,{children:"rust-analyzer-preview"}),"\n",(0,r.jsx)(t.li,{children:"rust-std"}),"\n",(0,r.jsx)(t.li,{children:"rustc"}),"\n",(0,r.jsx)(t.li,{children:"rustc-dev"}),"\n",(0,r.jsx)(t.li,{children:"rustfmt"}),"\n",(0,r.jsx)(t.li,{children:"rust-src"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(t.h3,{id:"build-process",children:"Build Process"}),"\n",(0,r.jsx)(t.p,{children:"The build process for the Rust Loader integrates Cargo builds into the CMake build system:"}),"\n",(0,r.jsxs)(t.ol,{children:["\n",(0,r.jsx)(t.li,{children:"CMake detects the Rust toolchain using FindRust.cmake"}),"\n",(0,r.jsx)(t.li,{children:"The build type (Debug/Release) determines compilation flags"}),"\n",(0,r.jsx)(t.li,{children:"Cargo is invoked to build the Rust implementation (rs_loader_impl)"}),"\n",(0,r.jsx)(t.li,{children:"On Linux/macOS, patchelf patches the runtime path in the libraries"}),"\n",(0,r.jsx)(t.li,{children:"The built libraries are copied to the output directory"}),"\n"]}),"\n",(0,r.jsx)(t.p,{children:'Debug builds produce libraries with a "d" suffix, while release builds produce optimized libraries without the suffix.'}),"\n",(0,r.jsx)(t.h3,{id:"runtime-dependencies",children:"Runtime Dependencies"}),"\n",(0,r.jsx)(t.p,{children:"The Rust Loader requires several runtime dependencies:"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:"Rust standard library and runtime libraries"}),"\n",(0,r.jsx)(t.li,{children:"The compiled rs_loader_impl library"}),"\n"]}),"\n",(0,r.jsx)(t.p,{children:"These dependencies are installed alongside MetaCall to ensure proper execution of Rust code at runtime."}),"\n",(0,r.jsx)(t.h2,{id:"configuration-and-debugging",children:"Configuration and Debugging"}),"\n",(0,r.jsx)(t.h3,{id:"environment-variables",children:"Environment Variables"}),"\n",(0,r.jsx)(t.p,{children:"The Rust Loader uses several environment variables that aid in development and debugging:"}),"\n",(0,r.jsxs)(t.table,{children:[(0,r.jsx)(t.thead,{children:(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.th,{children:"Environment Variable"}),(0,r.jsx)(t.th,{children:"Purpose"})]})}),(0,r.jsxs)(t.tbody,{children:[(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"RUST_BACKTRACE=1"}),(0,r.jsx)(t.td,{children:"Enables full backtrace for Rust panics"})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"RUST_LOG=INFO"}),(0,r.jsx)(t.td,{children:"Sets the logging level for Rust code"})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"These variables help with debugging Rust code loaded through MetaCall."}),(0,r.jsx)(t.td,{})]})]})]}),"\n",(0,r.jsx)(t.h3,{id:"build-options",children:"Build Options"}),"\n",(0,r.jsxs)(t.p,{children:["The Rust Loader can be enabled or disabled in the MetaCall build through the CMake option ",(0,r.jsx)(t.code,{children:"OPTION_BUILD_LOADERS_RS"}),". When disabled, components that depend on the Rust Loader will also be disabled."]}),"\n",(0,r.jsx)(t.h2,{id:"limitations-and-future-work",children:"Limitations and Future Work"}),"\n",(0,r.jsx)(t.h3,{id:"current-limitations",children:"Current Limitations"}),"\n",(0,r.jsxs)(t.ol,{children:["\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"Outdated Toolchain"}),": Requires an outdated nightly Rust toolchain (2021-12-04)"]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"No MUSL Support"}),": Doesn't support the MUSL toolchain for static linking"]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"Limited Type Conversion"}),": May not support all possible type conversions between Rust and other languages"]}),"\n"]}),"\n",(0,r.jsx)(t.h3,{id:"future-improvements",children:"Future Improvements"}),"\n",(0,r.jsx)(t.p,{children:"Potential areas for improvement include:"}),"\n",(0,r.jsxs)(t.ol,{children:["\n",(0,r.jsx)(t.li,{children:"Updating to support modern Rust toolchains"}),"\n",(0,r.jsx)(t.li,{children:"Adding MUSL support for static linking"}),"\n",(0,r.jsx)(t.li,{children:"Expanding type conversion capabilities"}),"\n",(0,r.jsx)(t.li,{children:"Supporting more Rust features like async/await"}),"\n",(0,r.jsx)(t.li,{children:"Optimizing the build process"}),"\n"]}),"\n",(0,r.jsxs)(t.p,{children:["Sources: ",(0,r.jsx)(t.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/rs_loader/CMakeLists.txt#L7-L17",children:"source/loaders/rs_loader/CMakeLists.txt7-17"})]})]})}function h(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},8453:(e,t,s)=>{s.d(t,{R:()=>a,x:()=>n});var l=s(6540);const r={},i=l.createContext(r);function a(e){const t=l.useContext(i);return l.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function n(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),l.createElement(i.Provider,{value:t},e.children)}}}]);