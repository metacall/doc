"use strict";(globalThis.webpackChunkmetacall_doc=globalThis.webpackChunkmetacall_doc||[]).push([[4852],{4942:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>r,default:()=>h,frontMatter:()=>o,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"metacall-core/python-loader","title":"Python Loader","description":"The Python Loader is a core component of MetaCall that enables loading and executing Python code at runtime, providing interoperability between Python and other programming languages supported by the MetaCall framework. This document covers the internal architecture, functionality, and implementation details of the Python Loader.","source":"@site/docs/metacall-core/python-loader.md","sourceDirName":"metacall-core","slug":"/metacall-core/python-loader","permalink":"/doc/pr-17/docs/metacall-core/python-loader","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"title":"Python Loader"},"sidebar":"tutorialSidebar","previous":{"title":"Prerequisites","permalink":"/doc/pr-17/docs/metacall-core/prerequisites"},"next":{"title":"Python Port","permalink":"/doc/pr-17/docs/metacall-core/python-port"}}');var s=t(4848),l=t(8453);const o={title:"Python Loader"},r="Python Loader",a={},c=[{value:"Overview",id:"overview",level:2},{value:"Architecture and Components",id:"architecture-and-components",level:2},{value:"Loader Implementation Structure",id:"loader-implementation-structure",level:3},{value:"Initialization and Configuration",id:"initialization-and-configuration",level:2},{value:"Type Conversion System",id:"type-conversion-system",level:2},{value:"Function Discovery and Calling Mechanism",id:"function-discovery-and-calling-mechanism",level:2},{value:"Asynchronous Function Support",id:"asynchronous-function-support",level:2},{value:"The Python Port",id:"the-python-port",level:2},{value:"Class and Object System",id:"class-and-object-system",level:2},{value:"Error Handling and Exception Propagation",id:"error-handling-and-exception-propagation",level:2},{value:"Building and Deployment",id:"building-and-deployment",level:2},{value:"Usage Examples",id:"usage-examples",level:2},{value:"Threading and GIL Management",id:"threading-and-gil-management",level:2},{value:"Conclusion",id:"conclusion",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"python-loader",children:"Python Loader"})}),"\n",(0,s.jsx)(n.p,{children:"The Python Loader is a core component of MetaCall that enables loading and executing Python code at runtime, providing interoperability between Python and other programming languages supported by the MetaCall framework. This document covers the internal architecture, functionality, and implementation details of the Python Loader."}),"\n",(0,s.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,s.jsx)(n.p,{children:"The Python Loader enables MetaCall to load Python scripts dynamically, expose Python functions to other language environments, and call functions from other languages within Python code. It serves as a bridge between the Python runtime and MetaCall's reflection system, handling type conversions, function discovery, and cross-language function invocation."}),"\n",(0,s.jsx)(n.h2,{id:"architecture-and-components",children:"Architecture and Components"}),"\n",(0,s.jsx)(n.p,{children:"The Python Loader follows a modular design that integrates with both the MetaCall Core and the Python C API. It consists of several key components:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"py_loader_impl"}),": Main implementation that handles loading, discovering, and executing Python code"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"py_loader_dict"}),": Utilities for working with Python dictionaries"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"py_loader_port"}),": MetaCall bindings for Python code to call back into MetaCall"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"py_loader_threading"}),": Thread management for Python's GIL (Global Interpreter Lock)"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"loader-implementation-structure",children:"Loader Implementation Structure"}),"\n",(0,s.jsx)(n.p,{children:"The Python Loader implements several key data structures:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"loader_impl_py_type"}),": Main implementation structure that holds references to Python modules and functions needed for reflection and async support"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"loader_impl_py_function_type"}),": Represents a Python function in the MetaCall value system"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"loader_impl_py_future_type"}),": Represents an async Python future for handling asynchronous calls"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"loader_impl_py_class_type"}),": Represents a Python class"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"loader_impl_py_object_type"}),": Represents a Python object instance"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"initialization-and-configuration",children:"Initialization and Configuration"}),"\n",(0,s.jsx)(n.p,{children:"The Python Loader initialization process involves setting up the Python interpreter, importing required modules, and configuring the execution environment."}),"\n",(0,s.jsx)(n.p,{children:"The initialization process involves:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Initializing the Python interpreter if not already initialized"}),"\n",(0,s.jsx)(n.li,{children:"Importing essential Python modules (inspect, asyncio, builtins, traceback)"}),"\n",(0,s.jsx)(n.li,{children:"Setting up the module search path (sys.path)"}),"\n",(0,s.jsx)(n.li,{children:"Registering MetaCall functions for use within Python code"}),"\n",(0,s.jsx)(n.li,{children:"Initializing threading support for the Python GIL"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"type-conversion-system",children:"Type Conversion System"}),"\n",(0,s.jsx)(n.p,{children:"One of the most important aspects of the Python Loader is the type conversion system that translates between Python objects and MetaCall values. This enables seamless data transfer between different language environments."}),"\n",(0,s.jsx)(n.p,{children:"The type conversion system consists of two main functions:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"py_loader_impl_capi_to_value_type"}),": Determines the MetaCall value type for a given Python object"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"py_loader_impl_capi_to_value"}),": Converts a Python object to a MetaCall value"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"py_loader_impl_value_to_capi"}),": Converts a MetaCall value to a Python object"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"The following table shows the complete type mapping between Python and MetaCall:"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Python Type"}),(0,s.jsx)(n.th,{children:"MetaCall Type"}),(0,s.jsx)(n.th,{children:"Notes"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"bool"}),(0,s.jsx)(n.td,{children:"TYPE_BOOL"}),(0,s.jsx)(n.td,{children:"Boolean values"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"int"}),(0,s.jsx)(n.td,{children:"TYPE_INT/TYPE_LONG"}),(0,s.jsx)(n.td,{children:"Integer values"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"float"}),(0,s.jsx)(n.td,{children:"TYPE_DOUBLE"}),(0,s.jsx)(n.td,{children:"Floating-point values"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"str"}),(0,s.jsx)(n.td,{children:"TYPE_STRING"}),(0,s.jsx)(n.td,{children:"String values"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"bytes"}),(0,s.jsx)(n.td,{children:"TYPE_BUFFER"}),(0,s.jsx)(n.td,{children:"Binary data"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"list/tuple"}),(0,s.jsx)(n.td,{children:"TYPE_ARRAY"}),(0,s.jsx)(n.td,{children:"Sequential collections"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"dict"}),(0,s.jsx)(n.td,{children:"TYPE_MAP"}),(0,s.jsx)(n.td,{children:"Key-value mappings"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"function"}),(0,s.jsx)(n.td,{children:"TYPE_FUNCTION"}),(0,s.jsx)(n.td,{children:"Callable functions"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"None"}),(0,s.jsx)(n.td,{children:"TYPE_NULL"}),(0,s.jsx)(n.td,{children:"Null/None values"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"class"}),(0,s.jsx)(n.td,{children:"TYPE_CLASS"}),(0,s.jsx)(n.td,{children:"Class definitions"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"object"}),(0,s.jsx)(n.td,{children:"TYPE_OBJECT"}),(0,s.jsx)(n.td,{children:"Class instances"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"coroutine"}),(0,s.jsx)(n.td,{children:"TYPE_FUTURE"}),(0,s.jsx)(n.td,{children:"Async functions"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"exception"}),(0,s.jsx)(n.td,{children:"TYPE_EXCEPTION"}),(0,s.jsx)(n.td,{children:"Error objects"})]})]})]}),"\n",(0,s.jsx)(n.h2,{id:"function-discovery-and-calling-mechanism",children:"Function Discovery and Calling Mechanism"}),"\n",(0,s.jsx)(n.p,{children:"The Python Loader discovers functions in loaded Python modules through reflection and makes them available to the MetaCall system. It also implements the mechanism for calling functions both synchronously and asynchronously."}),"\n",(0,s.jsx)(n.p,{children:"The function discovery process:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Loads Python code via file, memory, or package"}),"\n",(0,s.jsx)(n.li,{children:"Imports the module into the Python runtime"}),"\n",(0,s.jsx)(n.li,{children:"Uses Python's introspection capabilities to discover functions, classes, and methods"}),"\n",(0,s.jsx)(n.li,{children:"Registers discovered functions with the MetaCall reflection system"}),"\n",(0,s.jsx)(n.li,{children:"Sets up appropriate conversion and calling mechanisms"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Function calling workflow:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Receives function name and arguments from MetaCall"}),"\n",(0,s.jsx)(n.li,{children:"Converts MetaCall values to Python objects"}),"\n",(0,s.jsx)(n.li,{children:"Calls the Python function with the converted arguments"}),"\n",(0,s.jsx)(n.li,{children:"Converts the Python return value back to a MetaCall value"}),"\n",(0,s.jsx)(n.li,{children:"Returns the result to the caller"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"asynchronous-function-support",children:"Asynchronous Function Support"}),"\n",(0,s.jsx)(n.p,{children:"The Python Loader implements support for Python's asynchronous programming model using the asyncio library. This allows calling Python async functions and receiving results through MetaCall's future mechanism."}),"\n",(0,s.jsx)(n.p,{children:"The Python Loader implements several key components for async support:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Detection of async functions using Python's inspection mechanisms"}),"\n",(0,s.jsx)(n.li,{children:"Creating and managing asyncio event loops"}),"\n",(0,s.jsx)(n.li,{children:"Executing coroutines and tracking their state"}),"\n",(0,s.jsx)(n.li,{children:"Converting between Python futures and MetaCall futures"}),"\n",(0,s.jsx)(n.li,{children:"Handling callback resolution for asynchronous results"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"the-python-port",children:"The Python Port"}),"\n",(0,s.jsx)(n.p,{children:"The Python Port complements the Python Loader by providing a way to call MetaCall functions from Python code. It allows Python scripts to seamlessly access functions defined in other languages through MetaCall."}),"\n",(0,s.jsx)(n.p,{children:"The Python Port provides several key functions to Python code:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"metacall"}),": Call functions from other languages"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"metacall_load_from_file"}),": Load code from files"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"metacall_load_from_memory"}),": Load code from strings"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"metacall_load_from_package"}),": Load code from packages"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"metacall_inspect"}),": Introspect loaded functions and modules"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Additionally, it implements import monkey patching, allowing Python code to import modules from other languages using standard Python import syntax."}),"\n",(0,s.jsx)(n.h2,{id:"class-and-object-system",children:"Class and Object System"}),"\n",(0,s.jsx)(n.p,{children:"The Python Loader supports working with Python classes and objects, allowing them to be passed between language boundaries and their methods to be called."}),"\n",(0,s.jsx)(n.p,{children:"The Python Loader implements interfaces for working with classes and objects:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"py_class_interface"}),": Interface for Python classes"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Creating new instances (constructor)"}),"\n",(0,s.jsx)(n.li,{children:"Accessing static attributes"}),"\n",(0,s.jsx)(n.li,{children:"Calling static methods"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"py_object_interface"}),": Interface for Python objects"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Accessing instance attributes"}),"\n",(0,s.jsx)(n.li,{children:"Setting instance attributes"}),"\n",(0,s.jsx)(n.li,{children:"Calling instance methods"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"This system allows for object-oriented programming across language boundaries, preserving class identity and instance state."}),"\n",(0,s.jsx)(n.h2,{id:"error-handling-and-exception-propagation",children:"Error Handling and Exception Propagation"}),"\n",(0,s.jsx)(n.p,{children:"The Python Loader includes mechanisms for handling Python exceptions and propagating them through the MetaCall system. This ensures that errors in Python code are properly reported to callers in other languages."}),"\n",(0,s.jsx)(n.p,{children:"The error handling system:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Detects Python exceptions after function calls"}),"\n",(0,s.jsx)(n.li,{children:"Extracts exception type, value, and traceback information"}),"\n",(0,s.jsx)(n.li,{children:"Converts this information to a MetaCall exception value"}),"\n",(0,s.jsx)(n.li,{children:"Propagates the exception to the caller"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"This ensures that Python errors are properly handled and reported, regardless of which language initiated the call."}),"\n",(0,s.jsx)(n.h2,{id:"building-and-deployment",children:"Building and Deployment"}),"\n",(0,s.jsx)(n.p,{children:"The Python Loader is built as a dynamically loadable module that can be loaded by the MetaCall core. It requires the Python development libraries to be available during compilation."}),"\n",(0,s.jsx)(n.p,{children:"The build process:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Checks if the Python Loader is enabled in the build configuration"}),"\n",(0,s.jsx)(n.li,{children:"Finds the Python development libraries"}),"\n",(0,s.jsx)(n.li,{children:"Sets up compiler and linker flags"}),"\n",(0,s.jsx)(n.li,{children:"Builds the Python Loader module"}),"\n",(0,s.jsx)(n.li,{children:"Installs the module and dependencies"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"usage-examples",children:"Usage Examples"}),"\n",(0,s.jsx)(n.p,{children:"The Python Loader can be used in various ways to enable cross-language function calls:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Calling Python from C/C++"}),":"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Calling other languages from Python"}),":"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Using async/await with Python"}),":"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"threading-and-gil-management",children:"Threading and GIL Management"}),"\n",(0,s.jsx)(n.p,{children:"The Python Loader implements proper management of Python's Global Interpreter Lock (GIL) to ensure thread safety when calling Python functions from multiple threads."}),"\n",(0,s.jsx)(n.p,{children:"The threading system:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Acquires the Python GIL before calling into Python code"}),"\n",(0,s.jsx)(n.li,{children:"Executes the Python function or operation"}),"\n",(0,s.jsx)(n.li,{children:"Releases the GIL when returning to the calling environment"}),"\n",(0,s.jsx)(n.li,{children:"Handles thread state management for asynchronous operations"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"This ensures that Python's thread-safety requirements are respected while still allowing MetaCall to operate in a multi-threaded environment."}),"\n",(0,s.jsx)(n.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,s.jsx)(n.p,{children:"The Python Loader is a critical component of the MetaCall ecosystem, enabling seamless integration between Python and other programming languages. It handles the complexities of cross-language type conversion, function discovery, class/object interaction, and asynchronous programming to provide a unified function call interface."}),"\n",(0,s.jsxs)(n.p,{children:["For information about other language loaders, see the ",(0,s.jsx)(n.a,{href:"/doc/pr-17/docs/metacall-core/loaders",children:"Loaders"})," section."]})]})}function h(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>r});var i=t(6540);const s={},l=i.createContext(s);function o(e){const n=i.useContext(l);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),i.createElement(l.Provider,{value:n},e.children)}}}]);