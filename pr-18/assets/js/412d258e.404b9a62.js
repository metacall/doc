"use strict";(globalThis.webpackChunkmetacall_doc=globalThis.webpackChunkmetacall_doc||[]).push([[1422],{4981:(e,o,n)=>{n.r(o),n.d(o,{assets:()=>a,contentTitle:()=>i,default:()=>h,frontMatter:()=>d,metadata:()=>r,toc:()=>t});const r=JSON.parse('{"id":"metacall-core/node-js-loader","title":"Node.js Loader","description":"The Node.js Loader enables MetaCall to load, execute, and interact with JavaScript code running in the Node.js runtime. This loader is a core component that bridges the gap between the Node.js ecosystem and other language runtimes within MetaCall, enabling seamless interoperability between JavaScript and other supported languages.","source":"@site/docs/metacall-core/node-js-loader.md","sourceDirName":"metacall-core","slug":"/metacall-core/node-js-loader","permalink":"/doc/pr-18/docs/metacall-core/node-js-loader","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"title":"Node.js Loader"},"sidebar":"tutorialSidebar","previous":{"title":"Loading Code","permalink":"/doc/pr-18/docs/metacall-core/loading-code"},"next":{"title":"Node.js Port","permalink":"/doc/pr-18/docs/metacall-core/node-js-port"}}');var l=n(4848),s=n(8453);const d={title:"Node.js Loader"},i="Node.js Loader",a={},t=[{value:"Overview",id:"overview",level:2},{value:"Architecture",id:"architecture",level:2},{value:"Initialization Process",id:"initialization-process",level:2},{value:"Loader Initialization",id:"loader-initialization",level:3},{value:"Loading JavaScript Code",id:"loading-javascript-code",level:2},{value:"Loading from Files",id:"loading-from-files",level:3},{value:"Loading from Memory",id:"loading-from-memory",level:3},{value:"Function Discovery and Execution",id:"function-discovery-and-execution",level:2},{value:"Function Discovery",id:"function-discovery",level:3},{value:"Function Execution",id:"function-execution",level:3},{value:"Asynchronous Support",id:"asynchronous-support",level:2},{value:"Promise and Async/Await Support",id:"promise-and-asyncawait-support",level:3},{value:"Type Conversion",id:"type-conversion",level:2},{value:"Type Mapping",id:"type-mapping",level:3},{value:"Node.js to MetaCall Conversion",id:"nodejs-to-metacall-conversion",level:3},{value:"MetaCall to Node.js Conversion",id:"metacall-to-nodejs-conversion",level:3},{value:"Thread Safety and Interoperability",id:"thread-safety-and-interoperability",level:2},{value:"Thread-Safe Communication",id:"thread-safe-communication",level:3},{value:"Build and Configuration",id:"build-and-configuration",level:2},{value:"Build Dependencies",id:"build-dependencies",level:3},{value:"Configuration Options",id:"configuration-options",level:3},{value:"Building the Node.js Loader",id:"building-the-nodejs-loader",level:3},{value:"Limitations and Known Issues",id:"limitations-and-known-issues",level:2},{value:"Known Issues",id:"known-issues",level:3},{value:"Usage Examples",id:"usage-examples",level:2},{value:"Loading and Calling JavaScript Code",id:"loading-and-calling-javascript-code",level:3},{value:"Working with Asynchronous Functions",id:"working-with-asynchronous-functions",level:3},{value:"Internal Components",id:"internal-components",level:2},{value:"Trampoline System",id:"trampoline-system",level:3},{value:"Bootstrap Module",id:"bootstrap-module",level:3},{value:"Integration with TypeScript",id:"integration-with-typescript",level:2}];function c(e){const o={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(o.header,{children:(0,l.jsx)(o.h1,{id:"nodejs-loader",children:"Node.js Loader"})}),"\n",(0,l.jsx)(o.p,{children:"The Node.js Loader enables MetaCall to load, execute, and interact with JavaScript code running in the Node.js runtime. This loader is a core component that bridges the gap between the Node.js ecosystem and other language runtimes within MetaCall, enabling seamless interoperability between JavaScript and other supported languages."}),"\n",(0,l.jsx)(o.h2,{id:"overview",children:"Overview"}),"\n",(0,l.jsx)(o.p,{children:"The Node.js Loader allows MetaCall to:"}),"\n",(0,l.jsxs)(o.ol,{children:["\n",(0,l.jsx)(o.li,{children:"Load and evaluate JavaScript code from files or memory"}),"\n",(0,l.jsx)(o.li,{children:"Execute JavaScript functions and handle their return values"}),"\n",(0,l.jsx)(o.li,{children:"Support asynchronous operations through promises"}),"\n",(0,l.jsx)(o.li,{children:"Convert data types between Node.js and MetaCall's type system"}),"\n",(0,l.jsx)(o.li,{children:"Enable JavaScript code to call functions implemented in other languages"}),"\n"]}),"\n",(0,l.jsxs)(o.p,{children:["For information about using MetaCall from Node.js, see the ",(0,l.jsx)(o.a,{href:"/doc/pr-18/docs/metacall-core/node-js-port",children:"Node.js Port"}),"."]}),"\n",(0,l.jsxs)(o.ul,{children:["\n",(0,l.jsx)(o.li,{children:(0,l.jsx)(o.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/source/node_loader_impl.cpp#L1-L146",children:"source/loaders/node_loader/source/node_loader_impl.cpp1-146"})}),"\n",(0,l.jsx)(o.li,{children:(0,l.jsx)(o.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/include/node_loader/node_loader_impl.h#L20-L41",children:"source/loaders/node_loader/include/node_loader/node_loader_impl.h20-41"})}),"\n"]}),"\n",(0,l.jsx)(o.h2,{id:"architecture",children:"Architecture"}),"\n",(0,l.jsx)(o.p,{children:"The Node.js Loader has a complex architecture that integrates the Node.js runtime with MetaCall's core system."}),"\n",(0,l.jsx)(o.p,{children:"The Node.js Loader consists of several key components:"}),"\n",(0,l.jsxs)(o.ol,{children:["\n",(0,l.jsxs)(o.li,{children:[(0,l.jsxs)(o.strong,{children:["Native Implementation (",(0,l.jsx)(o.code,{children:"node_loader_impl"}),")"]}),": Implements the loader interface for MetaCall, handling initialization, loading, function discovery, and function execution. Written in C++, it interfaces with Node.js through N-API."]}),"\n",(0,l.jsxs)(o.li,{children:[(0,l.jsxs)(o.strong,{children:["Native Trampoline (",(0,l.jsx)(o.code,{children:"node_loader_trampoline"}),")"]}),": Provides a bridge between the native loader implementation and JavaScript, registering native functions that can be called from JavaScript."]}),"\n",(0,l.jsxs)(o.li,{children:[(0,l.jsxs)(o.strong,{children:["JavaScript Bootstrap (",(0,l.jsx)(o.code,{children:"bootstrap.js"}),")"]}),": The JavaScript part of the loader that initializes the Node.js environment and provides functions for loading and executing JavaScript code."]}),"\n",(0,l.jsxs)(o.li,{children:[(0,l.jsx)(o.strong,{children:"Thread-Safe Communication"}),": The loader uses thread-safe mechanisms to communicate between the MetaCall thread and the Node.js event loop thread."]}),"\n"]}),"\n",(0,l.jsxs)(o.ul,{children:["\n",(0,l.jsx)(o.li,{children:(0,l.jsx)(o.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/source/node_loader_impl.cpp#L148-L713",children:"source/loaders/node_loader/source/node_loader_impl.cpp148-713"})}),"\n",(0,l.jsx)(o.li,{children:(0,l.jsx)(o.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/source/node_loader_trampoline.cpp#L1-L59",children:"source/loaders/node_loader/source/node_loader_trampoline.cpp1-59"})}),"\n",(0,l.jsx)(o.li,{children:(0,l.jsx)(o.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/bootstrap/lib/bootstrap.js#L1-L47",children:"source/loaders/node_loader/bootstrap/lib/bootstrap.js1-47"})}),"\n"]}),"\n",(0,l.jsx)(o.h2,{id:"initialization-process",children:"Initialization Process"}),"\n",(0,l.jsx)(o.h3,{id:"loader-initialization",children:"Loader Initialization"}),"\n",(0,l.jsx)(o.p,{children:"The Node.js Loader's initialization process involves several steps:"}),"\n",(0,l.jsxs)(o.p,{children:["The initialization process begins with MetaCall calling ",(0,l.jsx)(o.code,{children:"node_loader_impl_initialize"}),", which creates the loader implementation data structure and starts a separate thread for the Node.js runtime. The Node.js thread initializes the runtime, loads the bootstrap.js file, and sets up the function table that enables communication between JavaScript and native code."]}),"\n",(0,l.jsx)(o.p,{children:"Key steps in the initialization process:"}),"\n",(0,l.jsxs)(o.ol,{children:["\n",(0,l.jsx)(o.li,{children:"Create the loader implementation structure"}),"\n",(0,l.jsx)(o.li,{children:"Start a dedicated thread for Node.js"}),"\n",(0,l.jsx)(o.li,{children:"Initialize Node.js runtime in the separate thread"}),"\n",(0,l.jsx)(o.li,{children:"Load bootstrap.js and register function callbacks"}),"\n",(0,l.jsx)(o.li,{children:"Set up thread-safe communication channels"}),"\n"]}),"\n",(0,l.jsxs)(o.ul,{children:["\n",(0,l.jsx)(o.li,{children:(0,l.jsx)(o.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/source/node_loader_impl.cpp#L883-L963",children:"source/loaders/node_loader/source/node_loader_impl.cpp883-963"})}),"\n",(0,l.jsx)(o.li,{children:(0,l.jsx)(o.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/bootstrap/lib/bootstrap.js#L21-L46",children:"source/loaders/node_loader/bootstrap/lib/bootstrap.js21-46"})}),"\n",(0,l.jsx)(o.li,{children:(0,l.jsx)(o.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/source/node_loader_trampoline.cpp#L59-L127",children:"source/loaders/node_loader/source/node_loader_trampoline.cpp59-127"})}),"\n"]}),"\n",(0,l.jsx)(o.h2,{id:"loading-javascript-code",children:"Loading JavaScript Code"}),"\n",(0,l.jsx)(o.p,{children:"The Node.js Loader supports loading JavaScript code from files, memory, or packages."}),"\n",(0,l.jsx)(o.h3,{id:"loading-from-files",children:"Loading from Files"}),"\n",(0,l.jsx)(o.p,{children:"When loading code from files, the loader:"}),"\n",(0,l.jsxs)(o.ol,{children:["\n",(0,l.jsx)(o.li,{children:"Takes an array of file paths to load"}),"\n",(0,l.jsx)(o.li,{children:"Uses a thread-safe function to invoke the JavaScript loader in the Node.js thread"}),"\n",(0,l.jsxs)(o.li,{children:["The JavaScript loader (",(0,l.jsx)(o.code,{children:"node_loader_trampoline_load_from_file"}),") requires the modules and creates a handle"]}),"\n",(0,l.jsx)(o.li,{children:"The handle is returned to MetaCall"}),"\n"]}),"\n",(0,l.jsxs)(o.ul,{children:["\n",(0,l.jsx)(o.li,{children:(0,l.jsx)(o.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/source/node_loader_impl.cpp#L863-L872",children:"source/loaders/node_loader/source/node_loader_impl.cpp863-872"})}),"\n",(0,l.jsx)(o.li,{children:(0,l.jsx)(o.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/bootstrap/lib/bootstrap.js#L136-L157",children:"source/loaders/node_loader/bootstrap/lib/bootstrap.js136-157"})}),"\n"]}),"\n",(0,l.jsx)(o.h3,{id:"loading-from-memory",children:"Loading from Memory"}),"\n",(0,l.jsx)(o.p,{children:"Loading code from memory follows a similar pattern but executes the code directly instead of requiring a file:"}),"\n",(0,l.jsx)(o.p,{children:"The loader creates a new Node.js module, compiles the buffer as JavaScript code, and returns a handle to the exports."}),"\n",(0,l.jsxs)(o.ul,{children:["\n",(0,l.jsx)(o.li,{children:(0,l.jsx)(o.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/bootstrap/lib/bootstrap.js#L159-L200",children:"source/loaders/node_loader/bootstrap/lib/bootstrap.js159-200"})}),"\n",(0,l.jsx)(o.li,{children:(0,l.jsx)(o.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/source/node_loader_impl.cpp#L873-L882",children:"source/loaders/node_loader/source/node_loader_impl.cpp873-882"})}),"\n"]}),"\n",(0,l.jsx)(o.h2,{id:"function-discovery-and-execution",children:"Function Discovery and Execution"}),"\n",(0,l.jsx)(o.h3,{id:"function-discovery",children:"Function Discovery"}),"\n",(0,l.jsx)(o.p,{children:"The Node.js Loader uses a function discovery mechanism to introspect JavaScript functions and create metadata about them:"}),"\n",(0,l.jsx)(o.p,{children:"The discovery process:"}),"\n",(0,l.jsxs)(o.ol,{children:["\n",(0,l.jsx)(o.li,{children:"Takes a handle to loaded JavaScript code"}),"\n",(0,l.jsx)(o.li,{children:"Uses the espree parser to analyze each exported function"}),"\n",(0,l.jsx)(o.li,{children:"Extracts function signatures, including parameter names"}),"\n",(0,l.jsx)(o.li,{children:"Creates metadata for each function"}),"\n",(0,l.jsx)(o.li,{children:"Registers the functions with MetaCall"}),"\n"]}),"\n",(0,l.jsx)(o.p,{children:"The discovery function uses the espree parser (a JavaScript syntax parser) to analyze function signatures and identify parameter names, which enables MetaCall to provide named parameter support."}),"\n",(0,l.jsxs)(o.ul,{children:["\n",(0,l.jsx)(o.li,{children:(0,l.jsx)(o.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/bootstrap/lib/bootstrap.js#L226-L251",children:"source/loaders/node_loader/bootstrap/lib/bootstrap.js226-251"})}),"\n",(0,l.jsx)(o.li,{children:(0,l.jsx)(o.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/bootstrap/lib/bootstrap.js#L264-L307",children:"source/loaders/node_loader/bootstrap/lib/bootstrap.js264-307"})}),"\n",(0,l.jsx)(o.li,{children:(0,l.jsx)(o.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/source/node_loader_impl.cpp#L478-L477",children:"source/loaders/node_loader/source/node_loader_impl.cpp478-477"})}),"\n"]}),"\n",(0,l.jsx)(o.h3,{id:"function-execution",children:"Function Execution"}),"\n",(0,l.jsx)(o.p,{children:"When a JavaScript function is called through MetaCall, the following process occurs:"}),"\n",(0,l.jsx)(o.p,{children:"The function calling process:"}),"\n",(0,l.jsxs)(o.ol,{children:["\n",(0,l.jsxs)(o.li,{children:["MetaCall calls ",(0,l.jsx)(o.code,{children:"function_node_interface_invoke"})," with a function and arguments"]}),"\n",(0,l.jsx)(o.li,{children:"The arguments are converted from MetaCall values to Node.js values"}),"\n",(0,l.jsx)(o.li,{children:"A thread-safe function is used to invoke the JavaScript function in the Node.js thread"}),"\n",(0,l.jsx)(o.li,{children:"The JavaScript function executes and returns a result"}),"\n",(0,l.jsx)(o.li,{children:"The result is converted back to a MetaCall value"}),"\n",(0,l.jsx)(o.li,{children:"The converted result is returned to MetaCall"}),"\n"]}),"\n",(0,l.jsxs)(o.ul,{children:["\n",(0,l.jsx)(o.li,{children:(0,l.jsx)(o.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/source/node_loader_impl.cpp#L479-L508",children:"source/loaders/node_loader/source/node_loader_impl.cpp479-508"})}),"\n",(0,l.jsx)(o.li,{children:(0,l.jsx)(o.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/source/node_loader_impl.cpp#L853-L862",children:"source/loaders/node_loader/source/node_loader_impl.cpp853-862"})}),"\n"]}),"\n",(0,l.jsx)(o.h2,{id:"asynchronous-support",children:"Asynchronous Support"}),"\n",(0,l.jsx)(o.p,{children:"One of the most powerful features of the Node.js Loader is its support for asynchronous JavaScript code, including Promises and async/await."}),"\n",(0,l.jsx)(o.h3,{id:"promise-and-asyncawait-support",children:"Promise and Async/Await Support"}),"\n",(0,l.jsx)(o.p,{children:"The Node.js Loader provides special handling for asynchronous JavaScript code:"}),"\n",(0,l.jsxs)(o.ol,{children:["\n",(0,l.jsx)(o.li,{children:"When an async function or Promise is called via MetaCall, the loader creates a JavaScript Promise"}),"\n",(0,l.jsx)(o.li,{children:"The Promise is linked to MetaCall's callback system via trampolines"}),"\n",(0,l.jsx)(o.li,{children:"When the Promise resolves or rejects, the corresponding MetaCall callback is invoked"}),"\n",(0,l.jsx)(o.li,{children:"Results are converted between Node.js and MetaCall value systems"}),"\n"]}),"\n",(0,l.jsxs)(o.p,{children:["The ",(0,l.jsx)(o.code,{children:"function_node_interface_await"})," function handles this process, allowing MetaCall code to work with JavaScript Promises in a natural way."]}),"\n",(0,l.jsx)(o.p,{children:"Example from bootstrap.js:"}),"\n",(0,l.jsxs)(o.ul,{children:["\n",(0,l.jsx)(o.li,{children:(0,l.jsx)(o.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/bootstrap/lib/bootstrap.js#L345-L378",children:"source/loaders/node_loader/bootstrap/lib/bootstrap.js345-378"})}),"\n",(0,l.jsx)(o.li,{children:(0,l.jsx)(o.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/bootstrap/lib/bootstrap.js#L380-L409",children:"source/loaders/node_loader/bootstrap/lib/bootstrap.js380-409"})}),"\n",(0,l.jsx)(o.li,{children:(0,l.jsx)(o.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/source/node_loader_impl.cpp#L505-L508",children:"source/loaders/node_loader/source/node_loader_impl.cpp505-508"})}),"\n",(0,l.jsx)(o.li,{children:(0,l.jsx)(o.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/tests/metacall_node_async_test/source/metacall_node_async_test.cpp#L75-L143",children:"source/tests/metacall_node_async_test/source/metacall_node_async_test.cpp75-143"})}),"\n"]}),"\n",(0,l.jsx)(o.h2,{id:"type-conversion",children:"Type Conversion"}),"\n",(0,l.jsx)(o.p,{children:"The Node.js Loader includes a sophisticated type conversion system that translates between Node.js values and MetaCall values."}),"\n",(0,l.jsx)(o.h3,{id:"type-mapping",children:"Type Mapping"}),"\n",(0,l.jsxs)(o.table,{children:[(0,l.jsx)(o.thead,{children:(0,l.jsxs)(o.tr,{children:[(0,l.jsx)(o.th,{children:"MetaCall Type"}),(0,l.jsx)(o.th,{children:"Node.js Type"}),(0,l.jsx)(o.th,{children:"Conversion Function"})]})}),(0,l.jsxs)(o.tbody,{children:[(0,l.jsxs)(o.tr,{children:[(0,l.jsx)(o.td,{children:(0,l.jsx)(o.code,{children:"NULL"})}),(0,l.jsxs)(o.td,{children:[(0,l.jsx)(o.code,{children:"undefined"})," or ",(0,l.jsx)(o.code,{children:"null"})]}),(0,l.jsx)(o.td,{children:(0,l.jsx)(o.code,{children:"node_loader_impl_value_create_null"})})]}),(0,l.jsxs)(o.tr,{children:[(0,l.jsx)(o.td,{children:(0,l.jsx)(o.code,{children:"BOOL"})}),(0,l.jsx)(o.td,{children:(0,l.jsx)(o.code,{children:"Boolean"})}),(0,l.jsx)(o.td,{children:(0,l.jsx)(o.code,{children:"node_loader_impl_value_create_bool"})})]}),(0,l.jsxs)(o.tr,{children:[(0,l.jsx)(o.td,{children:(0,l.jsx)(o.code,{children:"CHAR"})}),(0,l.jsxs)(o.td,{children:[(0,l.jsx)(o.code,{children:"String"})," (length 1)"]}),(0,l.jsx)(o.td,{children:(0,l.jsx)(o.code,{children:"node_loader_impl_value_create_char"})})]}),(0,l.jsxs)(o.tr,{children:[(0,l.jsx)(o.td,{children:(0,l.jsx)(o.code,{children:"SHORT"})}),(0,l.jsx)(o.td,{children:(0,l.jsx)(o.code,{children:"Number"})}),(0,l.jsx)(o.td,{children:(0,l.jsx)(o.code,{children:"node_loader_impl_value_create_short"})})]}),(0,l.jsxs)(o.tr,{children:[(0,l.jsx)(o.td,{children:(0,l.jsx)(o.code,{children:"INT"})}),(0,l.jsx)(o.td,{children:(0,l.jsx)(o.code,{children:"Number"})}),(0,l.jsx)(o.td,{children:(0,l.jsx)(o.code,{children:"node_loader_impl_value_create_int"})})]}),(0,l.jsxs)(o.tr,{children:[(0,l.jsx)(o.td,{children:(0,l.jsx)(o.code,{children:"LONG"})}),(0,l.jsxs)(o.td,{children:[(0,l.jsx)(o.code,{children:"Number"})," or ",(0,l.jsx)(o.code,{children:"BigInt"})]}),(0,l.jsx)(o.td,{children:(0,l.jsx)(o.code,{children:"node_loader_impl_value_create_long"})})]}),(0,l.jsxs)(o.tr,{children:[(0,l.jsx)(o.td,{children:(0,l.jsx)(o.code,{children:"FLOAT"})}),(0,l.jsx)(o.td,{children:(0,l.jsx)(o.code,{children:"Number"})}),(0,l.jsx)(o.td,{children:(0,l.jsx)(o.code,{children:"node_loader_impl_value_create_float"})})]}),(0,l.jsxs)(o.tr,{children:[(0,l.jsx)(o.td,{children:(0,l.jsx)(o.code,{children:"DOUBLE"})}),(0,l.jsx)(o.td,{children:(0,l.jsx)(o.code,{children:"Number"})}),(0,l.jsx)(o.td,{children:(0,l.jsx)(o.code,{children:"node_loader_impl_value_create_double"})})]}),(0,l.jsxs)(o.tr,{children:[(0,l.jsx)(o.td,{children:(0,l.jsx)(o.code,{children:"STRING"})}),(0,l.jsx)(o.td,{children:(0,l.jsx)(o.code,{children:"String"})}),(0,l.jsx)(o.td,{children:(0,l.jsx)(o.code,{children:"node_loader_impl_value_create_string"})})]}),(0,l.jsxs)(o.tr,{children:[(0,l.jsx)(o.td,{children:(0,l.jsx)(o.code,{children:"BUFFER"})}),(0,l.jsxs)(o.td,{children:[(0,l.jsx)(o.code,{children:"Buffer"})," or ",(0,l.jsx)(o.code,{children:"ArrayBuffer"})]}),(0,l.jsx)(o.td,{children:(0,l.jsx)(o.code,{children:"node_loader_impl_value_create_buffer"})})]}),(0,l.jsxs)(o.tr,{children:[(0,l.jsx)(o.td,{children:(0,l.jsx)(o.code,{children:"ARRAY"})}),(0,l.jsx)(o.td,{children:(0,l.jsx)(o.code,{children:"Array"})}),(0,l.jsx)(o.td,{children:(0,l.jsx)(o.code,{children:"node_loader_impl_value_create_array"})})]}),(0,l.jsxs)(o.tr,{children:[(0,l.jsx)(o.td,{children:(0,l.jsx)(o.code,{children:"MAP"})}),(0,l.jsx)(o.td,{children:(0,l.jsx)(o.code,{children:"Object"})}),(0,l.jsx)(o.td,{children:(0,l.jsx)(o.code,{children:"node_loader_impl_value_create_map"})})]}),(0,l.jsxs)(o.tr,{children:[(0,l.jsx)(o.td,{children:(0,l.jsx)(o.code,{children:"PTR"})}),(0,l.jsx)(o.td,{children:"N-API External"}),(0,l.jsx)(o.td,{children:(0,l.jsx)(o.code,{children:"node_loader_impl_value_create_ptr"})})]}),(0,l.jsxs)(o.tr,{children:[(0,l.jsx)(o.td,{children:(0,l.jsx)(o.code,{children:"FUTURE"})}),(0,l.jsx)(o.td,{children:(0,l.jsx)(o.code,{children:"Promise"})}),(0,l.jsx)(o.td,{children:(0,l.jsx)(o.code,{children:"node_loader_impl_value_create_future"})})]}),(0,l.jsxs)(o.tr,{children:[(0,l.jsx)(o.td,{children:(0,l.jsx)(o.code,{children:"FUNCTION"})}),(0,l.jsx)(o.td,{children:(0,l.jsx)(o.code,{children:"Function"})}),(0,l.jsx)(o.td,{children:(0,l.jsx)(o.code,{children:"node_loader_impl_value_create_function"})})]})]})]}),"\n",(0,l.jsx)(o.h3,{id:"nodejs-to-metacall-conversion",children:"Node.js to MetaCall Conversion"}),"\n",(0,l.jsxs)(o.p,{children:["The conversion from Node.js values to MetaCall values is handled by the ",(0,l.jsx)(o.code,{children:"node_loader_impl_napi_to_value"})," function:"]}),"\n",(0,l.jsx)(o.p,{children:"The conversion process:"}),"\n",(0,l.jsxs)(o.ol,{children:["\n",(0,l.jsx)(o.li,{children:"Determine the type of the Node.js value"}),"\n",(0,l.jsx)(o.li,{children:"Apply the appropriate conversion function"}),"\n",(0,l.jsx)(o.li,{children:"Create a MetaCall value of the corresponding type"}),"\n",(0,l.jsx)(o.li,{children:"Handle special cases like Maps, Arrays, Functions, and Promises"}),"\n"]}),"\n",(0,l.jsxs)(o.ul,{children:["\n",(0,l.jsx)(o.li,{children:(0,l.jsx)(o.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/source/node_loader_impl.cpp#L1210-L1529",children:"source/loaders/node_loader/source/node_loader_impl.cpp1210-1529"})}),"\n"]}),"\n",(0,l.jsx)(o.h3,{id:"metacall-to-nodejs-conversion",children:"MetaCall to Node.js Conversion"}),"\n",(0,l.jsxs)(o.p,{children:["The conversion from MetaCall values to Node.js values is handled by the ",(0,l.jsx)(o.code,{children:"node_loader_impl_value_to_napi"})," function:"]}),"\n",(0,l.jsxs)(o.ul,{children:["\n",(0,l.jsx)(o.li,{children:(0,l.jsx)(o.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/source/node_loader_impl.cpp#L1530-L1827",children:"source/loaders/node_loader/source/node_loader_impl.cpp1530-1827"})}),"\n"]}),"\n",(0,l.jsx)(o.h2,{id:"thread-safety-and-interoperability",children:"Thread Safety and Interoperability"}),"\n",(0,l.jsx)(o.p,{children:"The Node.js Loader uses a complex system to ensure thread safety when interacting between MetaCall's threads and Node.js's event loop."}),"\n",(0,l.jsx)(o.h3,{id:"thread-safe-communication",children:"Thread-Safe Communication"}),"\n",(0,l.jsx)(o.p,{children:"The Node.js Loader uses N-API's thread-safe functions to safely communicate between MetaCall's thread and the Node.js event loop thread. This ensures that JavaScript code always executes on the Node.js thread, while allowing MetaCall to make calls from any thread."}),"\n",(0,l.jsx)(o.p,{children:"Key components of the thread-safety system:"}),"\n",(0,l.jsxs)(o.ol,{children:["\n",(0,l.jsxs)(o.li,{children:[(0,l.jsx)(o.strong,{children:"Thread-safe function wrappers"}),": ",(0,l.jsx)(o.code,{children:"loader_impl_threadsafe_type"})," template class that wraps N-API's thread-safe functions"]}),"\n",(0,l.jsxs)(o.li,{children:[(0,l.jsx)(o.strong,{children:"Async context structures"}),": Structures like ",(0,l.jsx)(o.code,{children:"loader_impl_async_func_call_safe_type"})," that carry data between threads"]}),"\n",(0,l.jsxs)(o.li,{children:[(0,l.jsx)(o.strong,{children:"Mutex and condition variables"}),": Used for synchronization between threads"]}),"\n",(0,l.jsxs)(o.li,{children:[(0,l.jsx)(o.strong,{children:"Event loop integration"}),": The loader ensures that JavaScript code executes on the Node.js event loop"]}),"\n"]}),"\n",(0,l.jsxs)(o.ul,{children:["\n",(0,l.jsx)(o.li,{children:(0,l.jsx)(o.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/source/node_loader_impl.cpp#L166-L407",children:"source/loaders/node_loader/source/node_loader_impl.cpp166-407"})}),"\n",(0,l.jsx)(o.li,{children:(0,l.jsx)(o.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/source/node_loader_impl.cpp#L879-L889",children:"source/loaders/node_loader/source/node_loader_impl.cpp879-889"})}),"\n"]}),"\n",(0,l.jsx)(o.h2,{id:"build-and-configuration",children:"Build and Configuration"}),"\n",(0,l.jsx)(o.p,{children:"The Node.js Loader has several build and configuration options that control its behavior."}),"\n",(0,l.jsx)(o.h3,{id:"build-dependencies",children:"Build Dependencies"}),"\n",(0,l.jsx)(o.p,{children:"The Node.js Loader requires:"}),"\n",(0,l.jsxs)(o.ol,{children:["\n",(0,l.jsx)(o.li,{children:"Node.js development headers (v10 or later)"}),"\n",(0,l.jsx)(o.li,{children:"V8 JavaScript engine headers"}),"\n",(0,l.jsx)(o.li,{children:"libuv headers (if not using shared libuv)"}),"\n"]}),"\n",(0,l.jsx)(o.h3,{id:"configuration-options",children:"Configuration Options"}),"\n",(0,l.jsx)(o.p,{children:"The loader can be configured using CMake options:"}),"\n",(0,l.jsxs)(o.table,{children:[(0,l.jsx)(o.thead,{children:(0,l.jsxs)(o.tr,{children:[(0,l.jsx)(o.th,{children:"Option"}),(0,l.jsx)(o.th,{children:"Description"})]})}),(0,l.jsxs)(o.tbody,{children:[(0,l.jsxs)(o.tr,{children:[(0,l.jsx)(o.td,{children:(0,l.jsx)(o.code,{children:"OPTION_BUILD_LOADERS_NODE"})}),(0,l.jsx)(o.td,{children:"Enable or disable building the Node.js loader"})]}),(0,l.jsxs)(o.tr,{children:[(0,l.jsx)(o.td,{children:(0,l.jsx)(o.code,{children:"NodeJS_CMAKE_DEBUG"})}),(0,l.jsx)(o.td,{children:"Print paths for debugging Node.js dependencies"})]}),(0,l.jsxs)(o.tr,{children:[(0,l.jsx)(o.td,{children:(0,l.jsx)(o.code,{children:"NodeJS_EXECUTABLE_ONLY"})}),(0,l.jsx)(o.td,{children:"Find only Node.js executable (avoid library and include files)"})]}),(0,l.jsxs)(o.tr,{children:[(0,l.jsx)(o.td,{children:(0,l.jsx)(o.code,{children:"NodeJS_SHARED_UV"})}),(0,l.jsx)(o.td,{children:"If enabled, libuv won't be required by this script"})]}),(0,l.jsxs)(o.tr,{children:[(0,l.jsx)(o.td,{children:(0,l.jsx)(o.code,{children:"NodeJS_BUILD_FROM_SOURCE"})}),(0,l.jsx)(o.td,{children:"If enabled, Node.js runtime library will be built from source"})]}),(0,l.jsxs)(o.tr,{children:[(0,l.jsx)(o.td,{children:(0,l.jsx)(o.code,{children:"NodeJS_BUILD_WITHOUT_ICU"})}),(0,l.jsx)(o.td,{children:"If enabled, Node.js runtime library will be built without internationalization support"})]}),(0,l.jsxs)(o.tr,{children:[(0,l.jsx)(o.td,{children:(0,l.jsx)(o.code,{children:"NodeJS_INSTALL_PREFIX"})}),(0,l.jsx)(o.td,{children:"Define a custom install prefix for Node.js (Linux / Darwin only)"})]})]})]}),"\n",(0,l.jsxs)(o.ul,{children:["\n",(0,l.jsx)(o.li,{children:(0,l.jsx)(o.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/CMakeLists.txt#L1-L43",children:"source/loaders/node_loader/CMakeLists.txt1-43"})}),"\n",(0,l.jsx)(o.li,{children:(0,l.jsx)(o.a,{href:"https://github.com/metacall/core/blob/af9cad19/cmake/FindNodeJS.cmake#L6-L35",children:"cmake/FindNodeJS.cmake6-35"})}),"\n",(0,l.jsx)(o.li,{children:(0,l.jsx)(o.a,{href:"https://github.com/metacall/core/blob/af9cad19/cmake/FindNodeJS.cmake#L408-L623",children:"cmake/FindNodeJS.cmake408-623"})}),"\n"]}),"\n",(0,l.jsx)(o.h3,{id:"building-the-nodejs-loader",children:"Building the Node.js Loader"}),"\n",(0,l.jsx)(o.p,{children:"The build process for the Node.js Loader involves:"}),"\n",(0,l.jsxs)(o.ol,{children:["\n",(0,l.jsx)(o.li,{children:"Finding Node.js dependencies (headers and libraries)"}),"\n",(0,l.jsx)(o.li,{children:"Building or downloading the Node.js library if not available"}),"\n",(0,l.jsx)(o.li,{children:"Building the loader module"}),"\n",(0,l.jsx)(o.li,{children:"Installing the bootstrap.js file and dependencies"}),"\n"]}),"\n",(0,l.jsx)(o.p,{children:"If the Node.js library is not found, the build system can automatically download and build it from source, which is useful for systems where the Node.js shared library is not available."}),"\n",(0,l.jsxs)(o.ul,{children:["\n",(0,l.jsx)(o.li,{children:(0,l.jsx)(o.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/CMakeLists.txt#L1-L274",children:"source/loaders/node_loader/CMakeLists.txt1-274"})}),"\n",(0,l.jsx)(o.li,{children:(0,l.jsx)(o.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/bootstrap/CMakeLists.txt#L1-L115",children:"source/loaders/node_loader/bootstrap/CMakeLists.txt1-115"})}),"\n"]}),"\n",(0,l.jsx)(o.h2,{id:"limitations-and-known-issues",children:"Limitations and Known Issues"}),"\n",(0,l.jsx)(o.h3,{id:"known-issues",children:"Known Issues"}),"\n",(0,l.jsxs)(o.ol,{children:["\n",(0,l.jsxs)(o.li,{children:["\n",(0,l.jsxs)(o.p,{children:[(0,l.jsx)(o.strong,{children:"Fork Safety"}),": The Node.js Loader is not completely fork-safe due to how Node.js thread pools work with Linux's fork-one strategy."]}),"\n",(0,l.jsx)(o.pre,{children:(0,l.jsx)(o.code,{children:"To solve the deadlock we have to make MetaCall fork tolerant.\nThe problem is that when Linux makes a fork it uses fork-one strategy, this means\nthat only the caller thread is cloned, the others are not, so the NodeJS thread pool\ndoes not survive. When the thread pool tries to continue it blocks the whole application.\n"})}),"\n"]}),"\n",(0,l.jsxs)(o.li,{children:["\n",(0,l.jsxs)(o.p,{children:[(0,l.jsx)(o.strong,{children:"Node.js Initialization"}),": Node.js cannot be reinitialized, which complicates detour mechanisms."]}),"\n",(0,l.jsx)(o.pre,{children:(0,l.jsx)(o.code,{children:"Detour method is not valid because of NodeJS cannot be reinitialized, platform pointer already initialized in CHECK macro\n"})}),"\n"]}),"\n",(0,l.jsxs)(o.li,{children:["\n",(0,l.jsxs)(o.p,{children:[(0,l.jsx)(o.strong,{children:"Multi-Isolate Support"}),": The current implementation may not fully support multi-isolate environments."]}),"\n",(0,l.jsx)(o.pre,{children:(0,l.jsx)(o.code,{children:"TODO: The current implementation may not support multi-isolate environments. We should test it.\n"})}),"\n"]}),"\n",(0,l.jsxs)(o.li,{children:["\n",(0,l.jsxs)(o.p,{children:[(0,l.jsx)(o.strong,{children:"Memory Management"}),": Special care must be taken with memory management across language boundaries."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(o.ul,{children:["\n",(0,l.jsx)(o.li,{children:(0,l.jsx)(o.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/source/node_loader_impl.cpp#L125-L147",children:"source/loaders/node_loader/source/node_loader_impl.cpp125-147"})}),"\n",(0,l.jsx)(o.li,{children:(0,l.jsx)(o.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/source/node_loader_impl.cpp#L704-L706",children:"source/loaders/node_loader/source/node_loader_impl.cpp704-706"})}),"\n"]}),"\n",(0,l.jsx)(o.h2,{id:"usage-examples",children:"Usage Examples"}),"\n",(0,l.jsx)(o.h3,{id:"loading-and-calling-javascript-code",children:"Loading and Calling JavaScript Code"}),"\n",(0,l.jsx)(o.h3,{id:"working-with-asynchronous-functions",children:"Working with Asynchronous Functions"}),"\n",(0,l.jsxs)(o.ul,{children:["\n",(0,l.jsx)(o.li,{children:(0,l.jsx)(o.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/tests/metacall_node_async_test/source/metacall_node_async_test.cpp#L36-L264",children:"source/tests/metacall_node_async_test/source/metacall_node_async_test.cpp36-264"})}),"\n"]}),"\n",(0,l.jsx)(o.h2,{id:"internal-components",children:"Internal Components"}),"\n",(0,l.jsx)(o.h3,{id:"trampoline-system",children:"Trampoline System"}),"\n",(0,l.jsx)(o.p,{children:"The Node.js Loader uses a trampoline system to bridge between native code and JavaScript. The trampoline component implements functions that can be called from JavaScript and forwards them to the appropriate native implementations."}),"\n",(0,l.jsx)(o.p,{children:"Key trampoline functions include:"}),"\n",(0,l.jsxs)(o.ol,{children:["\n",(0,l.jsxs)(o.li,{children:[(0,l.jsx)(o.code,{children:"node_loader_trampoline_register"}),": Registers native functions with JavaScript"]}),"\n",(0,l.jsxs)(o.li,{children:[(0,l.jsx)(o.code,{children:"node_loader_trampoline_resolve"}),": Handles promise resolution"]}),"\n",(0,l.jsxs)(o.li,{children:[(0,l.jsx)(o.code,{children:"node_loader_trampoline_reject"}),": Handles promise rejection"]}),"\n",(0,l.jsxs)(o.li,{children:[(0,l.jsx)(o.code,{children:"node_loader_trampoline_destroy"}),": Cleans up resources"]}),"\n"]}),"\n",(0,l.jsxs)(o.ul,{children:["\n",(0,l.jsx)(o.li,{children:(0,l.jsx)(o.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/source/node_loader_trampoline.cpp#L12-L347",children:"source/loaders/node_loader/source/node_loader_trampoline.cpp12-347"})}),"\n",(0,l.jsx)(o.li,{children:(0,l.jsx)(o.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/bootstrap/lib/bootstrap.js#L411-L457",children:"source/loaders/node_loader/bootstrap/lib/bootstrap.js411-457"})}),"\n"]}),"\n",(0,l.jsx)(o.h3,{id:"bootstrap-module",children:"Bootstrap Module"}),"\n",(0,l.jsx)(o.p,{children:"The bootstrap.js module is the JavaScript component of the Node.js Loader, providing:"}),"\n",(0,l.jsxs)(o.ol,{children:["\n",(0,l.jsx)(o.li,{children:"JavaScript implementations of loader functions"}),"\n",(0,l.jsx)(o.li,{children:"Integration with Node.js's module system"}),"\n",(0,l.jsx)(o.li,{children:"Function introspection using the espree parser"}),"\n",(0,l.jsx)(o.li,{children:"Promise and async/await support"}),"\n"]}),"\n",(0,l.jsx)(o.p,{children:"The bootstrap module is loaded when the Node.js runtime initializes and serves as the bridge between native code and JavaScript."}),"\n",(0,l.jsxs)(o.ul,{children:["\n",(0,l.jsx)(o.li,{children:(0,l.jsx)(o.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/bootstrap/lib/bootstrap.js#L1-L457",children:"source/loaders/node_loader/bootstrap/lib/bootstrap.js1-457"})}),"\n",(0,l.jsx)(o.li,{children:(0,l.jsx)(o.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/node_loader/bootstrap/CMakeLists.txt#L1-L115",children:"source/loaders/node_loader/bootstrap/CMakeLists.txt1-115"})}),"\n"]}),"\n",(0,l.jsx)(o.h2,{id:"integration-with-typescript",children:"Integration with TypeScript"}),"\n",(0,l.jsx)(o.p,{children:"The Node.js Loader serves as the foundation for the TypeScript Loader, which extends its capabilities to support TypeScript code. The TypeScript Loader is implemented as a child loader of the Node.js Loader, using the same fundamental mechanisms but adding TypeScript-specific functionality."}),"\n",(0,l.jsx)(o.p,{children:"The relationship between the Node.js Loader and TypeScript Loader is shown below:"}),"\n",(0,l.jsx)(o.p,{children:"For more information about the TypeScript Loader, see the TypeScript Loader documentation."}),"\n",(0,l.jsxs)(o.ul,{children:["\n",(0,l.jsx)(o.li,{children:(0,l.jsx)(o.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/ts_loader/bootstrap/lib/bootstrap.ts#L1-L51",children:"source/loaders/ts_loader/bootstrap/lib/bootstrap.ts1-51"})}),"\n",(0,l.jsx)(o.li,{children:(0,l.jsx)(o.a,{href:"https://github.com/metacall/core/blob/af9cad19/source/loaders/ts_loader/bootstrap/CMakeLists.txt#L1-L146",children:"source/loaders/ts_loader/bootstrap/CMakeLists.txt1-146"})}),"\n"]})]})}function h(e={}){const{wrapper:o}={...(0,s.R)(),...e.components};return o?(0,l.jsx)(o,{...e,children:(0,l.jsx)(c,{...e})}):c(e)}},8453:(e,o,n)=>{n.d(o,{R:()=>d,x:()=>i});var r=n(6540);const l={},s=r.createContext(l);function d(e){const o=r.useContext(s);return r.useMemo(function(){return"function"==typeof e?e(o):{...o,...e}},[o,e])}function i(e){let o;return o=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:d(e.components),r.createElement(s.Provider,{value:o},e.children)}}}]);