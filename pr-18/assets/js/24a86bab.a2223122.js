"use strict";(globalThis.webpackChunkmetacall_doc=globalThis.webpackChunkmetacall_doc||[]).push([[4067],{7185:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>a,contentTitle:()=>l,default:()=>h,frontMatter:()=>r,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"metacall-core/detours-system","title":"Detours System","description":"The Detours System is a core component of MetaCall that enables function hooking, interception, and redirection at runtime. It allows MetaCall to intercept function calls and redirect them to alternative implementations, which is essential for cross-language function calls and ensuring thread safety in forked processes. This system is critical for MetaCall\'s ability to seamlessly integrate code from different programming languages.","source":"@site/docs/metacall-core/detours-system.md","sourceDirName":"metacall-core","slug":"/metacall-core/detours-system","permalink":"/doc/pr-18/docs/metacall-core/detours-system","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"title":"Detours System"},"sidebar":"tutorialSidebar","previous":{"title":"Creating Custom Loaders","permalink":"/doc/pr-18/docs/metacall-core/creating-custom-loaders"},"next":{"title":"Docker Builds","permalink":"/doc/pr-18/docs/metacall-core/docker-builds"}}');var s=n(4848),o=n(8453);const r={title:"Detours System"},l="Detours System",a={},c=[{value:"Architecture",id:"architecture",level:2},{value:"Main Components",id:"main-components",level:2},{value:"1. Detour API",id:"1-detour-api",level:3},{value:"2. FuncHook Implementation",id:"2-funchook-implementation",level:3},{value:"Function Interception Process",id:"function-interception-process",level:2},{value:"Integration with MetaCall Core",id:"integration-with-metacall-core",level:2},{value:"1. Cross-Language Function Calls",id:"1-cross-language-function-calls",level:3},{value:"2. Fork Safety",id:"2-fork-safety",level:3},{value:"Lifecycle Management",id:"lifecycle-management",level:2},{value:"Example Usage",id:"example-usage",level:2},{value:"Implementation and Extension",id:"implementation-and-extension",level:2},{value:"Relationship with Other MetaCall Systems",id:"relationship-with-other-metacall-systems",level:2},{value:"Conclusion",id:"conclusion",level:2}];function d(e){const t={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.header,{children:(0,s.jsx)(t.h1,{id:"detours-system",children:"Detours System"})}),"\n",(0,s.jsxs)(t.p,{children:["The Detours System is a core component of MetaCall that enables function hooking, interception, and redirection at runtime. It allows MetaCall to intercept function calls and redirect them to alternative implementations, which is essential for cross-language function calls and ensuring thread safety in forked processes. This system is critical for MetaCall's ability to seamlessly integrate code from different programming languages.\nFor information about the core Value System that handles data conversion between languages, see ",(0,s.jsx)(t.a,{href:"/doc/pr-18/docs/metacall-core/serialization-and-value-system",children:"Serialization and Value System"}),"."]}),"\n",(0,s.jsx)(t.h2,{id:"architecture",children:"Architecture"}),"\n",(0,s.jsx)(t.p,{children:"The Detours System is built as a modular component that integrates with the MetaCall Core. It provides a unified API for function interception while using a pluggable backend system that currently defaults to FuncHook."}),"\n",(0,s.jsx)(t.h2,{id:"main-components",children:"Main Components"}),"\n",(0,s.jsx)(t.h3,{id:"1-detour-api",children:"1. Detour API"}),"\n",(0,s.jsx)(t.p,{children:"The Detour API provides a consistent interface for function interception operations:"}),"\n",(0,s.jsxs)(t.table,{children:[(0,s.jsx)(t.thead,{children:(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.th,{children:"Function"}),(0,s.jsx)(t.th,{children:"Description"})]})}),(0,s.jsxs)(t.tbody,{children:[(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"detour_initialize()"})}),(0,s.jsx)(t.td,{children:"Initializes the detour system"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"detour_create(name)"})}),(0,s.jsx)(t.td,{children:'Creates a detour instance with the specified implementation (e.g., "funchook")'})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"detour_install(detour, target, hook)"})}),(0,s.jsx)(t.td,{children:"Installs a hook function to intercept calls to a target function"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"detour_trampoline(handle)"})}),(0,s.jsx)(t.td,{children:"Returns a pointer to the original target function"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"detour_uninstall(detour, handle)"})}),(0,s.jsx)(t.td,{children:"Removes a previously installed hook"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"detour_clear(detour)"})}),(0,s.jsx)(t.td,{children:"Clears a detour instance"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"detour_destroy()"})}),(0,s.jsx)(t.td,{children:"Destroys the detour system"})]})]})]}),"\n",(0,s.jsx)(t.h3,{id:"2-funchook-implementation",children:"2. FuncHook Implementation"}),"\n",(0,s.jsx)(t.p,{children:"The default detour implementation in MetaCall is FuncHook, an external library that provides cross-platform function hooking capabilities. FuncHook works by modifying the machine code of the target function at runtime to redirect execution to the hook function."}),"\n",(0,s.jsx)(t.p,{children:"MetaCall integrates version 1.1.3 of the FuncHook library:"}),"\n",(0,s.jsx)(t.h2,{id:"function-interception-process",children:"Function Interception Process"}),"\n",(0,s.jsx)(t.p,{children:"The process of intercepting a function call using the Detours System involves the following steps:"}),"\n",(0,s.jsx)(t.h2,{id:"integration-with-metacall-core",children:"Integration with MetaCall Core"}),"\n",(0,s.jsx)(t.p,{children:"The Detours System is initialized during MetaCall's core initialization process and is used for two primary purposes:"}),"\n",(0,s.jsx)(t.h3,{id:"1-cross-language-function-calls",children:"1. Cross-Language Function Calls"}),"\n",(0,s.jsx)(t.p,{children:"The Detours System is a critical component that enables function calls across different language runtimes. When you make a cross-language function call in MetaCall, the following happens:"}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsx)(t.li,{children:"MetaCall intercepts the function call using the Detours System"}),"\n",(0,s.jsx)(t.li,{children:"The call is redirected to the appropriate language runtime"}),"\n",(0,s.jsx)(t.li,{children:"Type conversion is performed using the Value System"}),"\n",(0,s.jsx)(t.li,{children:"The function is executed in the target language"}),"\n",(0,s.jsx)(t.li,{children:"The result is converted back to the caller's expected format"}),"\n"]}),"\n",(0,s.jsx)(t.h3,{id:"2-fork-safety",children:"2. Fork Safety"}),"\n",(0,s.jsxs)(t.p,{children:["When the ",(0,s.jsx)(t.code,{children:"METACALL_FLAGS_FORK_SAFE"})," flag is enabled, the Detours System helps ensure thread safety in forked processes:"]}),"\n",(0,s.jsxs)(t.p,{children:["This feature is important for applications that use the ",(0,s.jsx)(t.code,{children:"fork()"})," system call in multi-threaded environments, as it helps maintain the integrity of function hooks across process boundaries."]}),"\n",(0,s.jsx)(t.h2,{id:"lifecycle-management",children:"Lifecycle Management"}),"\n",(0,s.jsx)(t.p,{children:"The Detours System is properly initialized and destroyed as part of MetaCall's lifecycle:"}),"\n",(0,s.jsxs)(t.p,{children:["A special destructor function, ",(0,s.jsx)(t.code,{children:"metacall_detour_destructor()"}),", is registered with ",(0,s.jsx)(t.code,{children:"portability_atexit_register()"})," to ensure that the Detours System is properly cleaned up when the application exits."]}),"\n",(0,s.jsx)(t.h2,{id:"example-usage",children:"Example Usage"}),"\n",(0,s.jsx)(t.p,{children:"Here's an example of how to use the Detours System for function interception:"}),"\n",(0,s.jsx)(t.h2,{id:"implementation-and-extension",children:"Implementation and Extension"}),"\n",(0,s.jsx)(t.p,{children:"The Detours System in MetaCall is designed to be extensible. While FuncHook is the default implementation, the system architecture allows for additional hooking mechanisms to be added if needed."}),"\n",(0,s.jsx)(t.p,{children:"The current implementation is defined in the CMake configuration:"}),"\n",(0,s.jsx)(t.p,{children:"FuncHook is a cross-platform library that works on:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"Windows (x86/x64)"}),"\n",(0,s.jsx)(t.li,{children:"Linux (x86/x64)"}),"\n",(0,s.jsx)(t.li,{children:"macOS (x86/x64/ARM64)"}),"\n"]}),"\n",(0,s.jsx)(t.h2,{id:"relationship-with-other-metacall-systems",children:"Relationship with Other MetaCall Systems"}),"\n",(0,s.jsx)(t.p,{children:"The Detours System works closely with several other MetaCall components:"}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Loader System"}),": The detours mechanism helps the loader system invoke functions across language boundaries."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Value System"}),": After a function call is intercepted, the Value System handles the conversion of arguments and return values between different language type systems."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Fork Safety Module"}),": When enabled, the Detours System works with the fork safety module to ensure function hooks remain valid across process forks."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Linking System"}),": The metacall_link component utilizes detours to implement its functionality."]}),"\n"]}),"\n",(0,s.jsx)(t.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,s.jsx)(t.p,{children:"The Detours System is a fundamental component of MetaCall's architecture that enables seamless interoperability between different programming languages. By providing a robust mechanism for function interception, it allows MetaCall to redirect calls across language boundaries while maintaining type safety and ensuring correct behavior in complex scenarios such as multi-threaded applications with forking."})]})}function h(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},8453:(e,t,n)=>{n.d(t,{R:()=>r,x:()=>l});var i=n(6540);const s={},o=i.createContext(s);function r(e){const t=i.useContext(o);return i.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function l(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),i.createElement(o.Provider,{value:t},e.children)}}}]);